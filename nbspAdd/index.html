<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nbspAdd</title>
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../common/layui/css/layui.css"/>
    <script src="../common/layui/layui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.0/diff.min.js"></script>
    <script src="../common/components/ShowMessage.js" defer></script>
    <script src="../common/components/Loading.js" defer></script>
    <style>
        .diff-added {
            background-color: #d4fcbc;
            border: 1px solid #ffffff00;
        }
        .diff-added:hover {
            border: 1px solid #f44336;
            cursor: pointer;
        }

        .diff-removed {
            background-color: #fbb6c2;
        }

        #diffBox {
            font-size: 13px;
            color: #6f7184;
            margin: 10px 10px 0 0;
            padding: 12px;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div id="output" contenteditable
        style="width: 400px;height: 200px;border: 1px solid #ccc;margin:0 0 20px;overflow: auto; text-wrap: wrap;">
    </div>
    <button id="btnToNbsp" class="layui-btn layui-btn-sm layui-btn-primary layui-border">è½¬æ¢&amp;nbsp;å¹¶å¤åˆ¶</button>
    <button id="btnToNbspMcfly" class="layui-btn layui-btn-sm layui-btn-primary layui-border">è½¬æ¢:nbsp:å¹¶å¤åˆ¶</button>
    <button id="btnToClear" class="layui-btn layui-btn-sm layui-btn-primary layui-border">æ¸…é™¤å†…å®¹</button>
    <span style="visibility: hidden;font-size: 12px;color: #259e3f;margin-top: 6px;"
        id="textHidden">è½¬æ¢åçš„æ–‡æœ¬å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œ<span class="diff-removed">çº¢è‰²</span>ä¸ºåˆ é™¤çš„å†…å®¹ï¼Œ<span
            class="diff-added">ç»¿è‰²</span>åŠæ·»åŠ çš„æ–°çš„å†…å®¹ï¼Œç‚¹å‡»ç»¿è‰²æ–¹å—å¯ä»¥æ¢å¤åŸæ–‡æœ¬</span>
    <div id="diffBox"></div>
</body>
<script>
    let btnToNbsp = document.getElementById('btnToNbsp')
    let btnToNbspMcfly = document.getElementById('btnToNbspMcfly')
    let btnToClear = document.getElementById('btnToClear')
    let output = document.getElementById('output')
    let diffBox = document.getElementById('diffBox')

    function escapeHtml(text) {
        let element = document.createElement('div');
        element.innerText = text;
        return element.innerHTML;
    }
    function upDateClipboard(finalText){
        navigator.clipboard.writeText(finalText).then(function () {
            textHidden.style.visibility = "visible"
        }).catch(function (err) {
            alert('å¤åˆ¶å¤±è´¥: ' + err);
        });
    }

    function replaceSpacesWithNbsp(replacer) {
        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è‹±æ–‡å•è¯ä¹‹é—´çš„ç©ºæ ¼  
        // \b è¡¨ç¤ºå•è¯è¾¹ç•Œï¼Œ\s+ è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ ¼  
        // æ›¿æ¢ä¸º &nbsp;  
        const preOutputValue = output.innerText
        // å°† HTML æ ‡ç­¾æ›¿æ¢ä¸ºå ä½ç¬¦ï¼Œå¹¶è®°å½•æ ‡ç­¾
        const placeholderMap = {};
        const tempOutput = preOutputValue.replace(/<[^>]+>/g, (match) => {
            const placeholder = `@__HTML_TAG_${Object.keys(placeholderMap).length}__@`;
            placeholderMap[placeholder] = match; // ä¿å­˜åŸæ ‡ç­¾
            return placeholder;
        });
        console.log("ğŸš€ ~ ~ placeholderMap:", placeholderMap)
        const newText = tempOutput.replace(/\b\s+\b/g, replacer);
        // æ¢å¤åŸæ¥çš„ HTML æ ‡ç­¾
        const finalText = newText.replace(/@__HTML_TAG_\d+__@/g, (match) => placeholderMap[match]);

        upDateClipboard(finalText)

        // diffå¯¹æ¯”æ–‡æœ¬å‰åå˜åŒ–
        const old_text1 = escapeHtml(output.innerText)
        const old_text2 = escapeHtml(finalText)
        let diff = Diff.diffWords(old_text1, old_text2);
        let diffHtml = diff.map(function (part) {
            let color = part.added ? 'diff-added' : part.removed ? 'diff-removed' : '';
            return `<span class="${color}">${part.value.replace(/\n/g, '<br>')}</span>`;
        }).join('');

        diffBox.innerHTML = diffHtml;
        diffBox.style.border = '1px solid rgb(184 184 184)'
        const addSpans = diffBox.querySelectorAll('.diff-added')
        const delSpans = diffBox.querySelectorAll('.diff-removed')
        document.querySelectorAll('.diff-added').forEach((o, i) => {
            o.onclick = () => {
                diffBox.removeChild(addSpans[i - 1]);
                const spaceTextNode = document.createTextNode(' ');
                diffBox.replaceChild(spaceTextNode, delSpans[i - 1]);
                let new_element = document.createElement('div');
                new_element.innerHTML = diffBox.innerHTML
                new_element.querySelectorAll('.diff-removed').forEach((o)=>{
                    new_element.removeChild(o)
                })
                upDateClipboard(new_element.innerText)  //æ›´æ–°å‰ªè´´æ¿
                showMessage({msg:'å‰ªè´´æ¿å·²æ›´æ–°', type:'success',delay:1000})
            }
        })
        showMessage({msg:'è½¬æ¢æˆåŠŸ,å‰ªè´´æ¿å·²æ›´æ–°', type:'info'})
    }

    function clearTheTextValue() {
        textHidden.style.visibility = "hidden"
        output.innerText = ''
        diffBox.innerHTML = ''
        diffBox.style.border = '1px solid rgba(0,0,0,0)'
    }

    btnToNbsp.addEventListener('click', function () {
        replaceSpacesWithNbsp('&nbsp;')
    });

    btnToNbspMcfly.addEventListener('click', function () {
        replaceSpacesWithNbsp(':nbsp:')
    });

    btnToClear.addEventListener('click', function () {
        clearTheTextValue()
    })


    // ç¤ºä¾‹æ–‡æœ¬  

    // <p style="font-size: 12px; line-height: 16px; color: #6e6e73;"> <span>1.</span> è£ç½®æ•ˆèƒ½è¡¨ç¾å’Œå™ªéŸ³æ§åˆ¶åŠŸèƒ½åŒ…æ‹¬ä¸»å‹•æ¶ˆå™ªåŠŸèƒ½ã€é©æ‡‰æ€§éŸ³è¨ŠåŠé€šé€æ¨¡å¼ï¼Œå¯èƒ½å› ç¢å±‘æˆ–è€³å¢ç©èšè€Œæœ‰æ‰€å½±éŸ¿ã€‚å®šæœŸæ¸…æ½”è£ç½®ï¼Œä»¥ä¿æŒæ•ˆèƒ½è¡¨ç¾å’Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œã€‚æœ‰é—œ AirPods 4 æ¸…æ½”çš„æŒ‡å¼•è«‹åƒé–± <a href="${clicks.get('FN1a')}" style="color: #424245;">support.apple.com/zh-hk/102672</a>ã€‚æœ‰é—œ AirPods Pro 2 æ¸…æ½”çš„æŒ‡å¼•è«‹åƒé–± <a href="${clicks.get('FN1b')}" style="color: #424245;">support.apple.com/zh-hk/120409</a>ã€‚</p>

</script>

</html>