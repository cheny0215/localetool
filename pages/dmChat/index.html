<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff; /* çˆ±ä¸½ä¸è“ */
            color: #4a5a6a; /* çŸ³æ¿ç° */
            min-height: 100vh;
        }

        h1 {
            color: #6495ed; /* çŸ¢è½¦èŠè“ */
            text-align: center;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(100, 149, 237, 0.2);
        }

        h2, h3 {
            color: #7aaae0;
        }

        .chat-page {
            display: none;
            max-width: 1000px;
            margin: 20px auto;
        }

        .chat-wrapper {
            display: flex;
            gap: 20px;
        }

        .chat-main {
            flex: 1;
        }

        #chat-container {
            height: 450px;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            border-radius: 20px;
            border: 2px solid #add8e6; /* æ·¡è“è‰² */
            box-shadow: 0 4px 15px rgba(173, 216, 230, 0.3);
        }

        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .avatar-container {
            margin-right: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #b0e0e6; /* ç²‰è“è‰² */
        }

        .message-content-wrapper {
            flex: 1;
            background-color: #e0f2f7; /* æ·¡é’è‰²å˜ä½“ */
            border-radius: 15px;
            padding: 10px 15px;
            border-left: 3px solid #87ceeb; /* å¤©è“è‰² */
        }

        .username {
            font-weight: bold;
            color: #5f9ea0; /* å†›æ ¡è“ */
            margin-right: 8px;
        }

        .timestamp {
            color: #a0b9c4; /* æ·¡é’¢è“è‰²å˜ä½“ */
            font-size: 0.8em;
            margin-left: 10px;
        }

        .system .message-content-wrapper {
            background-color: #f0f8ff;
            border: 1px dashed #add8e6;
            color: #6495ed;
            text-align: center;
            padding: 8px;
            border-left: none;
        }

        .message-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 20px;
            border: 2px solid #add8e6;
            position: relative;
            box-shadow: 0 4px 15px rgba(173, 216, 230, 0.3);
        }

        .message-tools {
            display: flex;
            gap: 8px;
        }

        .tool-button {
            padding: 8px;
            cursor: pointer;
            background: #f0f8ff;
            border: 1px solid #b0e0e6;
            border-radius: 50%;
            font-size: 18px;
            transition: all 0.3s ease;
            color: #6495ed;
        }

        .tool-button:hover {
            background: #e0f2f7;
            transform: scale(1.1);
        }

        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #b0e0e6;
            border-radius: 15px;
            font-size: 14px;
            background-color: #faffff;
        }

        #message-input:focus {
            outline: none;
            border-color: #87ceeb;
            box-shadow: 0 0 5px rgba(135, 206, 235, 0.5);
        }

        button {
            padding: 10px 20px;
            border-radius: 15px;
            border: none;
            background: linear-gradient(to bottom, #87ceeb, #6495ed);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(100, 149, 237, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(100, 149, 237, 0.6);
        }

        .users-sidebar {
            width: 250px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 20px;
            border: 2px solid #add8e6;
            box-shadow: 0 4px 15px rgba(173, 216, 230, 0.3);
        }

        .users-sidebar h2 {
            margin-top: 0;
            font-size: 1.3em;
            padding-bottom: 10px;
            border-bottom: 1px dashed #b0e0e6;
            text-align: center;
        }

        .online-users {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .online-users li {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px dotted #e0f2f7;
            transition: background-color 0.2s;
        }

        .online-users li:hover {
            background-color: #f0f8ff;
            border-radius: 8px;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background-color: #98fb98; /* è‹ç»¿ */
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #8fbc8f; /* æš—æµ·ç»¿ */
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            border: 1px solid #b0e0e6;
        }

        .user-count {
            font-size: 0.9em;
            background-color: #e0f2f7;
            padding: 3px 8px;
            border-radius: 10px;
            color: #6495ed;
            margin-left: 5px;
        }

        .current-user {
            background-color: rgba(135, 206, 235, 0.15); /* æ·¡å¤©è“è‰²èƒŒæ™¯ */
            font-weight: bold;
            border-radius: 8px;
        }

        .current-user-badge {
            background-color: #87ceeb;
            color: white;
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 5px;
        }

        .avatar-upload, .user-settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #b0e0e6;
        }

        .avatar-upload h3, .user-settings h3 {
            text-align: center;
            margin-bottom: 15px;
        }

        #preview-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px auto;
            display: none;
            border: 3px solid #add8e6;
        }

        .avatar-upload input[type="file"] {
            display: block;
            margin: 10px auto;
            font-size: 12px;
            color: #778899; /* äº®çŸ³æ¿ç° */
        }

        .user-settings input {
            width: calc(100% - 22px); /* è°ƒæ•´å®½åº¦ä»¥é€‚åº”å†…è¾¹è·å’Œè¾¹æ¡† */
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #b0e0e6;
            border-radius: 10px;
            font-size: 14px;
        }

        .user-settings button,
        .avatar-upload button {
            width: 100%;
            margin-top: 5px;
        }

        .logout-button {
            margin-top: 30px;
            text-align: center;
        }

        .logout-button button {
            background: linear-gradient(to bottom, #ffb6c1, #ff7f9e); /* æ·¡ç²‰è‰²åˆ°æ·±ç²‰è‰² */
            box-shadow: 0 2px 5px rgba(255, 127, 158, 0.4);
        }

        .logout-button button:hover {
            box-shadow: 0 4px 8px rgba(255, 127, 158, 0.6);
        }

        .emoji-picker {
            position: absolute;
            bottom: 70px; /* è°ƒæ•´ä½ç½® */
            left: 10px;
            background: white;
            border: 1px solid #add8e6;
            border-radius: 15px;
            padding: 15px;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(173, 216, 230, 0.4);
        }

        .emoji-picker.active {
            display: grid;
        }

        .emoji-item {
            cursor: pointer;
            font-size: 22px;
            text-align: center;
            padding: 5px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .emoji-item:hover {
            background: #e0f2f7;
        }

        .message img.chat-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid #add8e6;
            margin-top: 5px;
        }

        .image-preview {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .image-preview img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .image-preview.active {
            display: flex;
        }

        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 20px;
            border: 2px solid #add8e6;
            box-shadow: 0 6px 20px rgba(173, 216, 230, 0.4);
            text-align: center;
        }

        .auth-container h2 {
            color: #6495ed;
            margin-bottom: 25px;
        }

        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #5f9ea0;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #b0e0e6;
            border-radius: 10px;
            font-size: 14px;
        }

        .form-group input[type="radio"] {
            margin-right: 5px;
        }
        .form-group label + label {
            margin-left: 15px;
        }

        .auth-container button {
            margin-top: 10px;
            width: calc(50% - 10px); /* ä¸¤ä¸ªæŒ‰é’®å¹¶æ’æ”¾ç½® */
            margin-right: 5px;
        }
        .auth-container button:last-of-type {
            margin-right: 0;
        }

        .error-message {
            color: #ff6b6b; /* æ·¡çŠç‘šè‰² */
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            font-size: 0.9em;
        }

        .certificate-notice {
            font-size: 12px;
            color: #6495ed;
            cursor: pointer;
            margin-bottom: 15px;
            padding: 8px;
            border: 1px dashed #add8e6;
            border-radius: 8px;
            background-color: #f0f8ff;
        }

        #certificate-steps {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #add8e6;
            font-size: 13px;
            line-height: 1.6;
            color: #4a5a6a;
            text-align: left;
        }
        #certificate-steps div {
            margin-bottom: 5px;
        }
        #certificate-steps a {
            color: #6495ed;
            text-decoration: none;
            font-weight: bold;
        }
        #certificate-steps a:hover {
            text-decoration: underline;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f8ff;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #add8e6;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #87ceeb;
        }

        /* è¦†ç›–æ¶ˆæ¯å†…å®¹ç»“æ„ä»¥å®ç°æ°”æ³¡æ•ˆæœ */
        .message {
            display: block; /* ç§»é™¤ flex å¸ƒå±€ */
        }
        .message .message-content { /* å®šä½åŸå§‹æ¶ˆæ¯å†…å®¹ */
            display: flex;
            align-items: flex-start;
        }
        .message .message-content-wrapper { /* åœ¨è¿™é‡Œåº”ç”¨æ°”æ³¡æ ·å¼ */
             /* æ ·å¼å·²åœ¨ä¸Šé¢å®šä¹‰ */
        }
        /* ç³»ç»Ÿæ¶ˆæ¯éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœç»“æ„æ”¹å˜ */
        .system {
             padding: 8px;
             background-color: #f0f8ff;
             border: 1px dashed #add8e6;
             color: #6495ed;
             text-align: center;
             border-radius: 15px;
             margin-bottom: 15px;
        }
        /* å¦‚æœéœ€è¦ï¼Œéšè—åŸå§‹ç³»ç»Ÿæ¶ˆæ¯åŒ…è£…å™¨ */
        .system .message-content-wrapper {
            display: none;
        }
        .system .message-content { /* ç›´æ¥è®¾ç½®ç³»ç»Ÿæ¶ˆæ¯å†…å®¹çš„æ ·å¼ */
            color: #6495ed;
        }

    </style>
</head>
<body>
    <div id="auth-page" class="auth-container">
        <h2>â˜ï¸ æ¬¢è¿æ¥åˆ°äº‘æœµèŠå¤©å®¤ â˜ï¸</h2>
        <div class="certificate-notice" onclick="toggleCertificateSteps()">âš ï¸ é¦–æ¬¡è®¿é—®æç¤ºï¼šéœ€è¦æ‰‹åŠ¨ä¿¡ä»»è¯ä¹¦å“¦ï¼(ç‚¹å‡»å±•å¼€/æ”¶èµ·)</div>
        <div id="certificate-steps" style="display:none">
            <div>1. åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ <a target="_blank" href="${CONFIG.SERVER_URL}">æ­¤ç½‘å€</a></div>
            <div>2. æµè§ˆå™¨å¯èƒ½ä¼šæç¤º"ä¸å®‰å…¨"ï¼Œè¯·ç‚¹å‡»"é«˜çº§"æˆ–ç±»ä¼¼é€‰é¡¹</div>
            <div>3. ç‚¹å‡»"ç»§ç»­å‰å¾€..." æˆ– "æ¥å—é£é™©å¹¶ç»§ç»­"</div>
            <div>4. å®Œæˆåï¼Œåˆ·æ–°æœ¬é¡µé¢æˆ–é‡æ–°æ‰“å¼€å³å¯æ­£å¸¸ç™»å½•/æ³¨å†Œâœ¨</div>
        </div>
        <script>
            function toggleCertificateSteps() {
                const steps = document.getElementById('certificate-steps');
                const notice = document.querySelector('.certificate-notice');
                if(steps.style.display === 'none') {
                    steps.style.display = 'block';
                    notice.innerHTML = 'âš ï¸ é¦–æ¬¡è®¿é—®æç¤ºï¼šéœ€è¦æ‰‹åŠ¨ä¿¡ä»»è¯ä¹¦å“¦ï¼(ç‚¹å‡»æ”¶èµ·)';
                } else {
                    steps.style.display = 'none';
                    notice.innerHTML = 'âš ï¸ é¦–æ¬¡è®¿é—®æç¤ºï¼šéœ€è¦æ‰‹åŠ¨ä¿¡ä»»è¯ä¹¦å“¦ï¼(ç‚¹å‡»å±•å¼€)';
                }
            }
        </script>
        <div id="error-message" class="error-message" style="display: none;"></div>

        <div id="login-form" class="auth-form active">
            <div class="form-group">
                <label for="login-username">æ˜µç§°ï¼š</label>
                <input type="text" id="login-username" placeholder="è¯·è¾“å…¥å¯çˆ±çš„æ˜µç§°å§~">
            </div>
            <div class="form-group">
                <label for="login-password">å¯†ç ï¼š</label>
                <input type="password" id="login-password" placeholder="è¾“å…¥å¯†ç ~">
            </div>
            <button onclick="login()">ç™»å½•</button>
            <button onclick="showRegister()" style="background: linear-gradient(to bottom, #b0e0e6, #87cefa);">æ³¨å†Œ</button>
        </div>

        <div id="register-form" class="auth-form">
            <div class="form-group">
                <label for="register-username">æ–°æ˜µç§°ï¼š</label>
                <input type="text" id="register-username" placeholder="æƒ³ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„åå­—~">
            </div>
            <div class="form-group">
                <label for="register-password">è®¾ç½®å¯†ç ï¼š</label>
                <input type="password" id="register-password" placeholder="æ‚„æ‚„è®¾ç½®å¯†ç ~">
            </div>
            <div class="form-group">
                <label>æ€§åˆ«ï¼š</label>
                <label>
                    <input type="radio" name="gender" value="male" checked> ğŸ‘¦ ç”·å­©
                </label>
                <label>
                    <input type="radio" name="gender" value="female"> ğŸ‘§ å¥³å­©
                </label>
            </div>
            <button onclick="register()">ç«‹å³æ³¨å†Œ</button>
            <button onclick="showLogin()" style="background: linear-gradient(to bottom, #f0f8ff, #e0f2f7); color: #6495ed;">è¿”å›ç™»å½•</button>
        </div>
    </div>

    <div id="chat-page" class="chat-page">
        <h1>â˜ï¸ äº‘æœµèŠå¤©å®¤ â˜ï¸</h1>
        <div class="chat-wrapper">
            <div class="chat-main">
                <div id="chat-container">
                    <!-- èŠå¤©æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
                <div class="message-input-container">
                    <div class="message-tools">
                        <button class="tool-button" onclick="toggleEmojiPicker()" title="è¡¨æƒ…">ğŸ˜Š</button>
                        <input type="file" id="image-input" accept="image/*" style="display: none" onchange="handleImageUpload(event)">
                        <button class="tool-button" onclick="document.getElementById('image-input').click()" title="å›¾ç‰‡">ğŸ–¼ï¸</button>
                    </div>
                    <input type="text" id="message-input" placeholder="æœ‰ä»€ä¹ˆæ–°é²œäº‹æƒ³åˆ†äº«å—~" onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">å‘é€</button>
                    <div class="emoji-picker" id="emoji-picker">
                        <!-- è¡¨æƒ…å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>

            <div class="users-sidebar">
                <h2>âœ¨ åœ¨çº¿å°ä¼™ä¼´ âœ¨</h2>
                <ul id="online-users" class="online-users">
                    <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
                </ul>
                <div class="user-count-wrapper" style="text-align: center; margin-top: 10px;">
                    å½“å‰åœ¨çº¿: <span id="user-count" class="user-count">(0)</span>
                </div>

                <div class="avatar-upload">
                    <h3>ğŸ€ æ›´æ¢å¤´åƒ ğŸ€</h3>
                    <img id="preview-avatar" src="" alt="å¤´åƒé¢„è§ˆ">
                    <input type="file" id="avatar-input" accept="image/*">
                    <button onclick="uploadAvatar()">ä¸Šä¼ æ–°å¤´åƒ</button>
                </div>

                <div class="user-settings">
                    <h3>âœï¸ ä¿®æ”¹æ˜µç§° âœï¸</h3>
                    <input type="text" id="new-username" placeholder="è¾“å…¥æ–°çš„æ˜µç§°~">
                    <button onclick="changeUsername()">ä¿å­˜æ–°æ˜µç§°</button>
                </div>

                <div class="logout-button">
                    <button onclick="logout()">é€€å‡ºç™»å½• ğŸ‘‹</button>
                </div>
            </div>
        </div>
    </div>

    <div class="image-preview" id="image-preview" style="display: none;" onclick="closeImagePreview()">
        <img src="" alt="é¢„è§ˆå›¾ç‰‡">
    </div>

    <script>
        let token = localStorage.getItem('chatToken');
        let ws = null;
        let currentUserId = '';
        let sessionId = '';  // æ·»åŠ ä¼šè¯IDç”¨äºè¯†åˆ«ä¸åŒè®¾å¤‡ç™»å½•
        const CONFIG = {
    SERVER_URL: 'https://10.148.60.37:3693',  // ä¸å¸¦ç«¯å£ï¼ŒNginxä¼šä»£ç†
    WS_URL: 'wss://10.148.60.37:3693',
    DEFAULT_AVATAR: 'https://10.148.60.37:3693/avatars/default1.png'
};

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (token) {
            connectWebSocket(token);
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¹¶è‡ªåŠ¨éšè—
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.textContent = `ğŸ˜¥ ${message}`;
                errorElement.style.display = 'block';
                // ä¿æŒé”™è¯¯ä¿¡æ¯å¯è§ï¼Œç›´åˆ°ä¸‹æ¬¡æ“ä½œæˆ–æ–°é”™è¯¯å‡ºç°
                // å¦‚æœéœ€è¦è‡ªåŠ¨éšè—ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢æ³¨é‡Š
                // setTimeout(() => {
                //     errorElement.textContent = '';
                //     errorElement.style.display = 'none';
                // }, 5000);
            }
        }

        // å‘é€æ¶ˆæ¯å‡½æ•°
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();

            if (!content) {
                showError('ä¸èƒ½å‘é€ç©ºæ¶ˆæ¯å“¦~');
                return;
            }

            if (content && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    content: content
                }));
                messageInput.value = '';
                // å…³é—­å¯èƒ½æ‰“å¼€çš„è¡¨æƒ…é€‰æ‹©å™¨
                document.getElementById('emoji-picker').classList.remove('active');
            } else {
                showError('è¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ T_T');
            }
        }

        // å¤„ç†æŒ‰å›è½¦å‘é€æ¶ˆæ¯
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯å‡½æ•° (é€‚é…æ–°æ ·å¼ç»“æ„)
        function displayMessage(message) {
            const chatContainer = document.getElementById('chat-container');
            const messageWrapper = document.createElement('div'); // æœ€å¤–å±‚å®¹å™¨
            messageWrapper.className = `message ${message.type}`;

            const timestamp = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const defaultAvatar = CONFIG.DEFAULT_AVATAR; // ä¿æŒä¸å˜

            let innerHTML;
            switch (message.type) {
                case 'chat':
                case 'emoji': // å°†è¡¨æƒ…è§†ä¸ºèŠå¤©ç»“æ„
                case 'image':
                    const avatarUrl = CONFIG.SERVER_URL + (message.avatar || defaultAvatar);
                    let contentHTML;
                    if (message.type === 'emoji') {
                        contentHTML = `<span style="font-size: 2em; vertical-align: middle;">${message.content}</span>`;
                    } else if (message.type === 'image') {
                        const imageUrl = CONFIG.SERVER_URL + message.content;
                        contentHTML = `<img src="${imageUrl}" alt="å›¾ç‰‡" class="chat-image" onclick="showImagePreview('${message.content}')">`;
                    } else {
                        // åŸºæœ¬ XSS é¢„é˜²ï¼šè½¬ä¹‰èŠå¤©å†…å®¹ä¸­çš„ HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.textContent = message.content;
                        contentHTML = tempDiv.innerHTML;
                    }

                    innerHTML = `
                        <div class="message-content">
                            <div class="avatar-container">
                                <img class="avatar" src="${avatarUrl}"
                                     alt="${message.username} å¤´åƒ" onerror="this.src='${defaultAvatar}'">
                            </div>
                            <div class="message-content-wrapper">
                                <span class="username">${message.username}:</span>
                                ${contentHTML}
                                <span class="timestamp">${timestamp}</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'system':
                    // ç³»ç»Ÿæ¶ˆæ¯ç»“æ„ (ç®€åŒ–)
                    innerHTML = `
                         <div class="message-content">
                             ${message.content}
                             <span class="timestamp">${timestamp}</span>
                         </div>
                     `;
                    break;
                default:
                     // æœªçŸ¥æ¶ˆæ¯ç±»å‹
                     innerHTML = `
                         <div class="message-content">
                             [æœªçŸ¥æ¶ˆæ¯ç±»å‹] ${message.content || ''}
                             <span class="timestamp">${timestamp}</span>
                         </div>
                     `;
            }

            messageWrapper.innerHTML = innerHTML;
            chatContainer.appendChild(messageWrapper);

            // æ»šåŠ¨åˆ°åº•éƒ¨
             chatContainer.scrollTop = chatContainer.scrollHeight;
        }


        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨å‡½æ•°
        function updateUserList(users) {
            const onlineUsers = document.getElementById('online-users');
            const userCount = document.getElementById('user-count');

            if (!onlineUsers || !userCount) return; // é˜²æ­¢å…ƒç´ æœªæ‰¾åˆ°

            onlineUsers.innerHTML = ''; // æ¸…é™¤ä¹‹å‰çš„åˆ—è¡¨
            userCount.textContent = `(${users.length})`;

            const defaultAvatar = CONFIG.DEFAULT_AVATAR; // é»˜è®¤å¤´åƒ

            users.forEach(user => {
                const li = document.createElement('li');
                const isCurrentUser = user.userId === currentUserId;

                if (isCurrentUser) {
                    li.classList.add('current-user');
                }

                const avatarUrl = CONFIG.SERVER_URL + (user.avatar || defaultAvatar);

                li.innerHTML = `
                    <span class="online-dot"></span>
                    <img class="user-avatar" src="${avatarUrl}"
                         alt="${user.username} å¤´åƒ" onerror="this.src='${defaultAvatar}'">
                    <span class="online-username">${user.username}</span>
                    ${isCurrentUser ? '<span class="current-user-badge">æˆ‘</span>' : ''}
                `;
                onlineUsers.appendChild(li);
            });
        }

        function connectWebSocket(token) {
            const wsUrl = `${CONFIG.WS_URL}?token=${token}`; // ä½¿ç”¨é…ç½®ä¸­çš„ WS_URL
            ws = new WebSocket(wsUrl);

            console.log('æ­£åœ¨è¿æ¥ WebSocket:', wsUrl);

            ws.onopen = () => {
                console.log('WebSocket è¿æ¥æˆåŠŸ âœ¿');
                document.getElementById('auth-page').style.display = 'none';
                document.getElementById('chat-page').style.display = 'block';

                try {
                    const tokenData = JSON.parse(atob(token.split('.')[1]));
                    currentUserId = tokenData.userId;
                } catch (error) {
                    console.error('è§£æ token å¤±è´¥:', error);
                    showError('æ— æ³•è§£æç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
                    logout(); // å¦‚æœ token æ— æ•ˆï¼Œå¼ºåˆ¶é€€å‡º
                    return;
                }

                sessionId = generateSessionId();
                ws.send(JSON.stringify({
                    type: 'session',
                    sessionId: sessionId
                }));
                 // è¿æ¥æˆåŠŸåéšè—ä¹‹å‰çš„ä»»ä½•é”™è¯¯æ¶ˆæ¯
                const errorElement = document.getElementById('error-message');
                if (errorElement) errorElement.style.display = 'none';
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    // console.log("æ”¶åˆ°æ¶ˆæ¯:", data); // è®°å½•æ”¶åˆ°çš„æ¶ˆæ¯

                    switch(data.type) {
                        case 'history':
                            document.getElementById('chat-container').innerHTML = ''; // é¦–å…ˆæ¸…é™¤å†å²è®°å½•
                            data.messages.forEach(msg => displayMessage(msg));
                            break;
                        case 'userList':
                            updateUserList(data.users);
                            break;
                        case 'forceLogout':
                            handleForceLogout();
                            break;
                        case 'chat':
                        case 'emoji':
                        case 'image':
                        case 'system':
                            displayMessage(data);
                            break;
                        default:
                            console.log("æ”¶åˆ°æœªçŸ¥ç±»å‹çš„æ¶ˆæ¯:", data);
                    }
                } catch (error) {
                    console.error("å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™:", error, "åŸå§‹æ•°æ®:", event.data);
                }
            };

            ws.onclose = (event) => {
                console.log('WebSocket å…³é—­:', event.code, event.reason);
                 // 4000 æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å¼ºåˆ¶ç™»å‡ºä»£ç ï¼Œä¸æ˜¾ç¤ºé€šç”¨é”™è¯¯
                if (event.code !== 1000 && event.code !== 4000) {
                    showError('è¿æ¥å·²æ–­å¼€ï¼Œè¯·å°è¯•é‡æ–°ç™»å½•');
                } else if (event.code === 1000 && !event.wasClean) {
                    // æ­£å¸¸å…³é—­ï¼Œä½†å¯èƒ½æ˜¯ç”±äºç½‘ç»œé—®é¢˜
                     showError('è¿æ¥æ„å¤–æ–­å¼€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå¹¶é‡è¯•');
                }
                // å…³é—­æ—¶æ€»æ˜¯è¿”å›è®¤è¯é¡µé¢ï¼Œé™¤éæ˜¯ç”±å¼ºåˆ¶ç™»å‡ºå¤„ç†çš„
                if (event.code !== 4000) {
                    document.getElementById('chat-page').style.display = 'none';
                    document.getElementById('auth-page').style.display = 'block';
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket é”™è¯¯:', error);
                showError('è¿æ¥èŠå¤©æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è¯ä¹¦è®¾ç½®');
                 // å¯é€‰ï¼šåœ¨å‡ºé”™æ—¶åˆ‡æ¢å›è®¤è¯é¡µé¢
                document.getElementById('chat-page').style.display = 'none';
                document.getElementById('auth-page').style.display = 'block';
            };
        }

        // ç”Ÿæˆéšæœºä¼šè¯ID
        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 15);
        }

        // å¤„ç†è¢«å¼ºåˆ¶ç™»å‡º
        function handleForceLogout() {
            showError('æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œæœ¬è®¾å¤‡å·²ä¸‹çº¿ T_T');
            localStorage.removeItem('chatToken');
            if (ws) {
                 // ä½¿ç”¨è‡ªå®šä¹‰ä»£ç å’ŒåŸå› 
                ws.close(4000, 'ä»å¦ä¸€å°è®¾å¤‡ç™»å½•');
            }
            // ç¡®ä¿å³ä½¿ onclose äº‹ä»¶å»¶è¿Ÿ/ä¸¢å¤±ï¼ŒUI ä¹Ÿæ›´æ–°
            document.getElementById('chat-page').style.display = 'none';
            document.getElementById('auth-page').style.display = 'block';
        }


        // ç™»å½•ç›¸å…³å‡½æ•°
        function showRegister() {
            document.getElementById('login-form').classList.remove('active');
            document.getElementById('register-form').classList.add('active');
            document.getElementById('error-message').style.display = 'none'; // åˆ‡æ¢è¡¨å•æ—¶éšè—é”™è¯¯
        }

        function showLogin() {
            document.getElementById('register-form').classList.remove('active');
            document.getElementById('login-form').classList.add('active');
             document.getElementById('error-message').style.display = 'none'; // åˆ‡æ¢è¡¨å•æ—¶éšè—é”™è¯¯
        }

        async function login() {
            const usernameInput = document.getElementById('login-username');
            const passwordInput = document.getElementById('login-password');
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showError("æ˜µç§°å’Œå¯†ç éƒ½ä¸èƒ½ä¸ºç©ºå“¦~");
                return;
            }

            try {
                console.log('å°è¯•ç™»å½•:', username);
                const response = await fetch(`${CONFIG.SERVER_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        deviceInfo: { // å¯é€‰ï¼šå‘é€è®¾å¤‡ä¿¡æ¯
                            type: 'web',
                            browser: navigator.userAgent.substring(0, 100), // é™åˆ¶é•¿åº¦
                            timestamp: new Date().toISOString()
                        }
                    }),
                });

                const data = await response.json();
                console.log('ç™»å½•å“åº”:', data);

                if (response.ok && data.token) {
                    localStorage.setItem('chatToken', data.token);
                    connectWebSocket(data.token);
                    passwordInput.value = ''; // æˆåŠŸç™»å½•å°è¯•åæ¸…é™¤å¯†ç å­—æ®µ
                } else {
                    showError(data.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜µç§°å’Œå¯†ç ');
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showError('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€');
            }
        }

        async function register() {
            const usernameInput = document.getElementById('register-username');
            const passwordInput = document.getElementById('register-password');
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const genderElement = document.querySelector('input[name="gender"]:checked');
            const gender = genderElement ? genderElement.value : 'male'; // å¦‚æœæœªé€‰æ‹©ï¼Œé»˜è®¤ä¸ºç”·æ€§

            if (!username || !password) {
                showError("æ˜µç§°å’Œå¯†ç éƒ½ä¸èƒ½ä¸ºç©ºå“¦~");
                return;
            }
            if (password.length < 4) { // ç¤ºä¾‹ï¼šåŸºæœ¬å¯†ç é•¿åº¦æ£€æŸ¥
                showError("å¯†ç è‡³å°‘éœ€è¦4ä½å“¦~");
                return;
            }


            try {
                const response = await fetch(`${CONFIG.SERVER_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, gender }),
                });

                const data = await response.json();
                if (response.ok && data.token) {
                     showError('æ³¨å†ŒæˆåŠŸï¼ç°åœ¨å°†è‡ªåŠ¨ç™»å½•...'); // ä½¿ç”¨ showError ä¿æŒä¸€è‡´æ€§
                     setTimeout(() => {
                         localStorage.setItem('chatToken', data.token);
                         connectWebSocket(data.token);
                         passwordInput.value = ''; // æ¸…é™¤å¯†ç 
                     }, 1000); // çŸ­æš‚å»¶è¿Ÿ
                } else {
                    showError(data.message || 'æ³¨å†Œå¤±è´¥ï¼Œæ˜µç§°å¯èƒ½å·²è¢«ä½¿ç”¨');
                }
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showError('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€');
            }
        }

        // é€€å‡ºç™»å½•åŠŸèƒ½
        function logout() {
            // æ·»åŠ ä¸€ä¸ªå¯çˆ±çš„ç¡®è®¤æ¡†
            if (confirm('çœŸçš„è¦ç¦»å¼€äº‘æœµèŠå¤©å®¤äº†å—ï¼ŸğŸ¥º')) {
                if (ws) {
                    // ä½¿ç”¨æ­£å¸¸ä»£ç å…³é—­
                    ws.close(1000, 'ç”¨æˆ·å·²ç™»å‡º');
                }
                localStorage.removeItem('chatToken');
                document.getElementById('chat-page').style.display = 'none';
                document.getElementById('auth-page').style.display = 'block';
                // å¯é€‰åœ°æ¸…é™¤å­—æ®µ
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
                // æ˜¾ç¤ºå¯çˆ±çš„ç™»å‡ºæ¶ˆæ¯
                showError('ä¸‹æ¬¡å†æ¥ç©å“¦~ ğŸ‘‹');
            }
        }


        // æ·»åŠ å¤´åƒé¢„è§ˆåŠŸèƒ½
        document.getElementById('avatar-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('preview-avatar');
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block'; // æ˜¾ç¤ºé¢„è§ˆ
                }
                reader.readAsDataURL(file);
            } else if (file) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å“¦~');
                preview.style.display = 'none'; // å¦‚æœæ–‡ä»¶æ— æ•ˆåˆ™éšè—é¢„è§ˆ
                e.target.value = ''; // æ¸…é™¤è¾“å…¥
            } else {
                 preview.style.display = 'none'; // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–‡ä»¶åˆ™éšè—
            }
        });

        // æ·»åŠ å¤´åƒä¸Šä¼ åŠŸèƒ½
        async function uploadAvatar() {
            const input = document.getElementById('avatar-input');
            const file = input.files[0];

            if (!file) {
                showError('è¿˜æ²¡æœ‰é€‰æ‹©å›¾ç‰‡å‘¢~');
                return;
            }
            if (file.size > 2 * 1024 * 1024) { // é™åˆ¶å¤§å°ä¸º 2MB
                showError('å›¾ç‰‡æœ‰ç‚¹å¤ªå¤§äº†å“¦ï¼ˆæœ€å¤§2MBï¼‰~');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', file);

            try {
                const response = await fetch(`${CONFIG.SERVER_URL}/api/auth/avatar`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await response.json();
                if (response.ok) {
                    showError('å¤´åƒæ›´æ–°æˆåŠŸï¼âœ¨');
                    document.getElementById('preview-avatar').style.display = 'none'; // ä¸Šä¼ åéšè—é¢„è§ˆ
                    input.value = ''; // æ¸…é™¤æ–‡ä»¶è¾“å…¥

                    // é‡æ–°è¿æ¥ä»¥ç«‹å³åœ¨å„å¤„æ›´æ–°å¤´åƒ
                    if (ws) ws.close(1000, 'å¤´åƒå·²æ›´æ–°ï¼Œæ­£åœ¨é‡æ–°è¿æ¥');
                    // åœ¨é‡æ–°è¿æ¥å‰æ·»åŠ ä¸€ä¸ªå°çš„å»¶è¿Ÿ
                    setTimeout(() => {
                         connectWebSocket(token);
                    }, 500);

                } else {
                    showError(data.message || 'å¤´åƒä¸Šä¼ å¤±è´¥äº† T_T');
                }
            } catch (error) {
                console.error("ä¸Šä¼ å¤´åƒé”™è¯¯:", error);
                showError('å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }
        }

        // ä¿®æ”¹ç”¨æˆ·ååŠŸèƒ½
        async function changeUsername() {
            const newUsernameInput = document.getElementById('new-username');
            const newUsername = newUsernameInput.value.trim();

            if (!newUsername) {
                showError('æ–°çš„æ˜µç§°ä¸èƒ½ä¸ºç©ºå“¦~');
                return;
            }
            if (newUsername.length > 15) { // ç¤ºä¾‹é•¿åº¦é™åˆ¶
                 showError('æ˜µç§°æœ‰ç‚¹å¤ªé•¿äº†å“¦ï¼ˆæœ€å¤š15ä¸ªå­—ï¼‰~');
                 return;
            }

            try {
                const response = await fetch(`${CONFIG.SERVER_URL}/api/auth/username`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username: newUsername })
                });

                const data = await response.json();
                if (response.ok) {
                    showError('æ˜µç§°ä¿®æ”¹æˆåŠŸï¼âœ¨');
                    newUsernameInput.value = ''; // æ¸…é™¤è¾“å…¥

                    // é‡æ–°è¿æ¥ä»¥ç«‹å³åœ¨å„å¤„æ›´æ–°ç”¨æˆ·å
                    if (ws) ws.close(1000, 'ç”¨æˆ·åå·²æ›´æ–°ï¼Œæ­£åœ¨é‡æ–°è¿æ¥');
                     // åœ¨é‡æ–°è¿æ¥å‰æ·»åŠ ä¸€ä¸ªå°çš„å»¶è¿Ÿ
                     setTimeout(() => {
                         connectWebSocket(token);
                     }, 500);

                } else {
                    showError(data.message || 'ä¿®æ”¹å¤±è´¥ï¼Œæ˜µç§°å¯èƒ½å·²è¢«ä½¿ç”¨æˆ–æ— æ•ˆ');
                }
            } catch (error) {
                console.error("ä¿®æ”¹æ˜µç§°é”™è¯¯:", error);
                showError('ä¿®æ”¹æ˜µç§°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }
        }

        // è¡¨æƒ…åˆ—è¡¨ (ä¿æŒè¡¨æƒ…ç®€å•)
        const emojis = [
            'ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜­', 'ğŸ™', 'ğŸ‘', 'ğŸ‰', 'âœ¨',
            'ğŸ’–', 'â­', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ˜‡', 'ğŸ¥º', 'ğŸ˜´', 'ğŸ‘‹', 'ğŸ‘€',
            'ğŸ', 'ğŸ“', 'ğŸ¦', 'ğŸ•', 'ğŸš€', 'ğŸˆ', 'ğŸ', 'ğŸ¶', 'ğŸ±', 'ğŸ°'
            // å¦‚æœéœ€è¦ï¼Œæ·»åŠ æ›´å¤šå¯çˆ±çš„è¡¨æƒ…
        ];

        // åˆå§‹åŒ–è¡¨æƒ…é€‰æ‹©å™¨
        function initEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.innerHTML = ''; // å…ˆæ¸…é™¤ç°æœ‰è¡¨æƒ…
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji-item';
                span.textContent = emoji;
                span.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢ç‚¹å‡»ç«‹å³å…³é—­é€‰æ‹©å™¨
                    addEmoji(emoji);
                    // å¯é€‰ï¼šé€‰æ‹©åå…³é—­é€‰æ‹©å™¨
                    // picker.classList.remove('active');
                };
                picker.appendChild(span);
            });
        }

        // åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨æ˜¾ç¤ºçŠ¶æ€
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.classList.toggle('active');
        }

        // æ·»åŠ è¡¨æƒ…åˆ°è¾“å…¥æ¡†
        function addEmoji(emoji) {
            const input = document.getElementById('message-input');
            input.value += emoji;
            input.focus(); // ä¿æŒç„¦ç‚¹åœ¨è¾“å…¥æ¡†
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å“¦~');
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB é™åˆ¶
                showError('å›¾ç‰‡å¤ªå¤§äº†å“¦ï¼ˆæœ€å¤§5MBï¼‰~');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            // å¦‚æœéœ€è¦ï¼Œæ˜¾ç¤ºä¸€ä¸ªä¸´æ—¶çš„"ä¸Šä¼ ä¸­"æŒ‡ç¤ºå™¨
            // displayMessage({ type: 'system', content: 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', timestamp: new Date() });

            try {
                const response = await fetch(`${CONFIG.SERVER_URL}/api/chat/image`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await response.json();
                if (response.ok && data.imageUrl) {
                    // é€šè¿‡ WebSocket å‘é€å›¾ç‰‡æ¶ˆæ¯
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'image',
                            content: data.imageUrl // å‘é€æœåŠ¡å™¨è¿”å›çš„ç›¸å¯¹ URL
                        }));
                    } else {
                         showError('è¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•å‘é€å›¾ç‰‡ T_T');
                    }
                } else {
                    showError(data.message || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥äº† T_T');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å›¾ç‰‡é”™è¯¯:', error);
                showError('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            } finally {
                // æ¸…é™¤æ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥é‡æ–°ä¸Šä¼ ç›¸åŒçš„æ–‡ä»¶
                event.target.value = '';
            }
        }

        // å›¾ç‰‡é¢„è§ˆ
        function showImagePreview(relativeUrl) {
             const preview = document.getElementById('image-preview');
             const imgElement = preview.querySelector('img');
             if (preview && imgElement) {
                 imgElement.src = `${CONFIG.SERVER_URL}${relativeUrl}`; // æ„å»ºå®Œæ•´ URL
                 preview.classList.add('active');
                 // ä¸éœ€è¦ display:flexï¼Œç±»ä¼šå¤„ç†å®ƒ
             }
        }

        function closeImagePreview() {
            const preview = document.getElementById('image-preview');
             if (preview) {
                preview.classList.remove('active');
                // æ¸…é™¤ src ä»¥é˜²æ­¢ä¸‹æ¬¡æ‰“å¼€æ—¶çŸ­æš‚é—ªçƒæ—§å›¾åƒ
                preview.querySelector('img').src = '';
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', () => {
            initEmojiPicker();

            // ç‚¹å‡»è¡¨æƒ…é€‰æ‹©å™¨å¤–éƒ¨å…³é—­å®ƒ
            document.addEventListener('click', (e) => {
                const picker = document.getElementById('emoji-picker');
                const emojiButton = document.querySelector('.tool-button[title="è¡¨æƒ…"]'); // æ›´å…·ä½“çš„é€‰æ‹©å™¨
                if (picker && picker.classList.contains('active')) {
                    if (!picker.contains(e.target) && e.target !== emojiButton && !emojiButton.contains(e.target)) {
                        picker.classList.remove('active');
                    }
                }
            });
        });
    </script>
</body>
</html> 