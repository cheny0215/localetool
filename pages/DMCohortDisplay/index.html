<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMä¸€é”®æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯</title>
    <link rel="stylesheet" href="../../common/layui/css/layui.css" />
    <link rel="stylesheet" href="../../css/index.css">
    <script src="../../common/layui/layui.js"></script>
    <script src="../../common/components/ShowMessage.js" defer></script>
    <script src="../../common/components/Loading.js" defer></script>
    <style>
        .alpineData {
            font-size: 14px;
            color: #333;
            display: flex;
            padding: 8px;
        }

        .leftAlpineBox {
            flex: 3;
            padding: 20px;
            border-radius: 6px;
        }

        .centerAlpineBox {
            padding: 20px;
            flex: 3;
            margin: 0 12px;
            border-radius: 6px;
        }

        .centerAlpineBox .layui-form-checkbox {
            margin-bottom: 4px;
        }

        .rightAlpineBox {
            padding: 20px;
            flex: 3;
            border-radius: 6px;
        }

        .data_textarea {
            resize: both;
            border: 1px solid #c2c2c2;
            border-radius: 4px;
        }

        .data_textarea::placeholder {
            color: #ccc;
        }

        .layui-btn {
            height: 36px;
            line-height: 36px;
            padding: 0 16px;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            transform: perspective(800px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .layui-btn-sm {
            margin: 6px 0;
            font-weight: 700;
            border-radius: 8px;
            /* background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%); */
            border: none;
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
        }

        .laybox {
            display: flex;
            flex-direction: column;
        }
        #cohortVarInput {
        color:cornflowerblue;
        }
        input[type="checkbox"]:checked {
            accent-color: #16baaa;
            color:azure;
        }
    </style>
</head>

<body>
    <div class="alpineData">
        <div class="leftAlpineBox layui-panel">
            <div class="tweHtml">
                <h4 style="color: #16baaa;">åŸå§‹htmlï¼š</h4>
                <hr>
                <textarea id="dataInput" class="data_textarea layui-textarea"
                    placeholder="è¯·å°†æˆ‘ä»¬çš„åŸå§‹HTMLä»£ç ç²˜è´´åˆ°è¿™é‡Œ"></textarea>
                <div>
                    <iframe id="myIframe" src="" frameborder="0"
                        style="width: 100%;border: 1px solid #d8d8d8;margin-top: 100px;height: 0 !important;visibility: hidden;"></iframe>
                    <div style="margin-top: 8px; color: #16a4ba; font-size: 12px;">
                        <i class="layui-icon layui-icon-notice" style="font-size: 14px;"></i>
                        æ¯ä½¿ç”¨ä¸€æ¬¡åï¼Œè¯·åˆ·æ–°é¡µé¢é˜²æ­¢ç¼“å­˜ï¼Œå†è¿›è¡Œä¸‹ä¸€æ¬¡ä½¿ç”¨
                    </div>
                    <div style="margin-top: 4px; color: #16baaa; font-size: 12px;">
                        <i class="layui-icon layui-icon-notice" style="font-size: 14px;"></i>
                        æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯ä¹‹å‰ä¸€å®šè¦ä¿ç•™åŸå§‹html
                    </div>
                </div>
            </div>
        </div>
        <div class="centerAlpineBox layui-panel">
            <div style="margin-top: 12px;">
                <label for="cohortVarInput" style="color: #16baaa;">ç‰ˆæœ¬å˜é‡å(é»˜è®¤ï¼š$cohort)ï¼š</label>
                <input id="cohortVarInput" type="text" value="$cohort" style="width: 120px; border: 1px solid #ccc; border-radius: 4px; padding: 2px 6px;">
            </div>

            <div style="margin-top: 12px;">
                <label style="color: #16baaa; cursor: pointer;">
                    <input type="checkbox" id="showVersionInfoCheckbox" style="cursor: pointer;vertical-align: text-top;" checked>
                    æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯æ ·å¼
                </label>
            </div>
            <div style="margin-top: 12px;">
                <label style="color: #16baaa; cursor: pointer;">
                    <input type="checkbox" id="showAltCheckbox" style="cursor: pointer;vertical-align: text-top;" checked>
                    æ˜¾ç¤ºå›¾ç‰‡Altæ–‡æœ¬
                </label>
            </div>
            <div style="margin-top: 12px;">
                <label style="color: #16baaa; cursor: pointer;">
                    <input type="checkbox" id="showTopToggleButtonCheckbox" style="cursor: pointer;vertical-align: text-top;" checked>
                    æ˜¾ç¤ºé‚®ä»¶é¡¶éƒ¨åˆ‡æ¢æŒ‰é’®
                </label>
            </div>
            <hr>
            <div class="layui-btn-container">
                <button id="submitButton"
                    class="layui-btn layui-btn-sm  layui-bg-green layui-icon layui-icon-component"> ä¸€é”®æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æ ·å¼ä»£ç 
                    âŠ</button>
                <button id="outputButton"
                    class="layui-btn layui-btn-sm  layui-bg-green layui-icon layui-icon-fonts-code"> ç”ŸæˆCode â‹</button>
            </div>
        </div>
        <div class="rightAlpineBox layui-panel">
            <h4 style="color: #16baaa;">æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯åhtmlï¼š</h4>
            <hr>
            <textarea id="dataOutput" class="data_textarea layui-textarea"
                placeholder="å¸¦æœ‰ç‰ˆæœ¬ä¿¡æ¯æ ·å¼çš„ä»£ç ä¼šå±•ç¤ºåœ¨è¿™é‡Œï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å³å¯å¤åˆ¶åˆ°å‰ªè´´æ¿ï½"></textarea>
            <hr>
            <div class="layui-btn-container">
                <button id="copyButton" class="layui-btn layui-btn-sm  layui-bg-green layui-icon layui-icon-file-b">
                    å¤åˆ¶ä»£ç  âŒ</button>
                <button id="resetButton" class="layui-btn layui-btn-sm  layui-bg-green layui-icon layui-icon-refresh">
                    åˆ·æ–°é¡µé¢ â</button>
            </div>
        </div>
    </div>
    <script>


        document.addEventListener('DOMContentLoaded', function () {
            const dataInput = document.getElementById('dataInput');
            const dataOutput = document.getElementById('dataOutput');
            const iframe = document.getElementById('myIframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            // Checkbox element
            const showAltCheckbox = document.getElementById('showAltCheckbox');
            const showVersionInfoCheckbox = document.getElementById('showVersionInfoCheckbox');
            const showTopToggleButtonCheckbox = document.getElementById('showTopToggleButtonCheckbox');
            const submitButton = document.getElementById('submitButton');
            const outputButton = document.getElementById('outputButton');
            const copyButton = document.getElementById('copyButton');
            const resetButton = document.getElementById('resetButton');

            let html_doc = '';
            let hiddenPreContent = '';
            let hiddenFontContent = '';
            let dynamicContent = '';
            const originalHexColorObj = {
                addMargin: [],
                delUnderline: [],
                delUnderlineImportant: [],
                appStoreNowrap: [],
            };
            let hexColorObj = originalHexColorObj
            const pre_placeholder = '<!-- [[PRE_PLACEHOLDER]] -->';
            const font_placeholder = '<!-- [[FONT_PLACEHOLDER]] -->';
            const zwnj_placeholder = '<!-- [[ZWNJ_PLACEHOLDER]] -->';
            const dynamic_placeholder = '<!-- [[DYNAMIC_PLACEHOLDER]] -->';

            // æ–°å¢ï¼šå˜é‡åè¾“å…¥æ¡†
            const cohortVarInput = document.getElementById('cohortVarInput');
            let cohortVarName = cohortVarInput.value.trim() || '$cohort';

            cohortVarInput.addEventListener('input', function () {
                cohortVarName = cohortVarInput.value.trim() || '$cohort';
            });

            // è”åŠ¨é€»è¾‘ï¼šå½“æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯æ ·å¼å’Œæ˜¾ç¤ºå›¾ç‰‡Altæ–‡æœ¬éƒ½ä¸å‹¾é€‰æ—¶ï¼Œç¦ç”¨å¹¶å–æ¶ˆå‹¾é€‰æ˜¾ç¤ºé‚®ä»¶é¡¶éƒ¨åˆ‡æ¢æŒ‰é’®
            function updateTopToggleButtonState() {
                const versionInfoChecked = showVersionInfoCheckbox.checked;
                const altTextChecked = showAltCheckbox.checked;
                
                if (!versionInfoChecked && !altTextChecked) {
                    // ä¸¤ä¸ªéƒ½ä¸å‹¾é€‰æ—¶ï¼Œç¦ç”¨å¹¶å–æ¶ˆå‹¾é€‰é¡¶éƒ¨åˆ‡æ¢æŒ‰é’®
                    showTopToggleButtonCheckbox.checked = false;
                    showTopToggleButtonCheckbox.disabled = true;
                    showTopToggleButtonCheckbox.style.cursor = 'not-allowed';
                    showTopToggleButtonCheckbox.style.opacity = '0.5';
                    showTopToggleButtonCheckbox.parentElement.style.color = '#ccc';
                } else {
                    // è‡³å°‘æœ‰ä¸€ä¸ªå‹¾é€‰æ—¶ï¼Œå¯ç”¨é¡¶éƒ¨åˆ‡æ¢æŒ‰é’®
                    showTopToggleButtonCheckbox.disabled = false;
                    showTopToggleButtonCheckbox.style.cursor = 'pointer';
                    showTopToggleButtonCheckbox.style.opacity = '1';
                    showTopToggleButtonCheckbox.parentElement.style.color = '#16baaa';
                }
            }
            
            // ç›‘å¬ä¸¤ä¸ªå¤é€‰æ¡†çš„å˜åŒ–
            showVersionInfoCheckbox.addEventListener('change', updateTopToggleButtonState);
            showAltCheckbox.addEventListener('change', updateTopToggleButtonState);
            
            // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            updateTopToggleButtonState();

            // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆå˜é‡åç›¸å…³çš„æ­£åˆ™
            function getCohortValueRegex() {
                // åŒ¹é… å˜é‡å == "xxx"
                return new RegExp(cohortVarName.replace(/\$/g, '\\$') + '\\s*==\\s*"([^"]+)"', 'g');
            }

            // inputäº‹ä»¶
            dataInput.addEventListener('input', function () {
                html_doc = dataInput.value;
                toPlaceholder()
                handleOutput()
            });

            // å ä½ç¬¦
            function toPlaceholder() {
                html_doc = html_doc.replace(/<div style="display: none; max-height: 0px; overflow: hidden;">([\s\S]*?)<\/div>/, (match, content) => {
                    console.log("ğŸš€ ~ html_doc=html_doc.replace ~ match:", match)
                    hiddenPreContent = match; // å­˜å‚¨å†…å®¹
                    return pre_placeholder; // æ›¿æ¢ä¸ºå ä½ç¬¦
                });
                html_doc = html_doc.replace(/\<!--\[if gte mso 9\]\>([\s\S]*)\<!\[endif\]--\>/, (match, content) => {
                    hiddenFontContent = match; // å­˜å‚¨å†…å®¹
                    return font_placeholder; // æ›¿æ¢ä¸ºå ä½ç¬¦
                });
                html_doc = html_doc.replace(/&zwnj;/g, zwnj_placeholder)
                // å­˜å‚¨<!DOCTYPEå‰é¢çš„æ‰€æœ‰å†…å®¹
                html_doc = html_doc.replace(/^[\s\S]*?(?=<!DOCTYPE)/i, (match) => {
                    dynamicContent = match; // å­˜å‚¨åŒ¹é…åˆ°çš„å†…å®¹
                    return dynamic_placeholder; // æ›¿æ¢ä¸ºå ä½ç¬¦
                });
            }
            function delPlaceholder(iframehtml) {
                iframehtml = iframehtml.replace(pre_placeholder, hiddenPreContent);      // æ›¿æ¢å ä½ç¬¦ä¸ºåŸå†…å®¹

                // åˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨ style æ ‡ç­¾
                if (!iframehtml.includes('<style name="dmc-cohort-display">')) {
                    // åœ¨<!--[if gte mso 9]>å‰é¢æ·»åŠ styleæ ·å¼ï¼ˆåŸºç¡€æ ·å¼ï¼Œå…·ä½“æ˜¾ç¤ºç”±toggleæ§åˆ¶ï¼‰
                    const styleToAdd = `<style name="dmc-cohort-display">
        table {
                border-collapse: collapse !important;
            }
    </style>\n`
                    ;

                    iframehtml = iframehtml.replace(font_placeholder, styleToAdd + hiddenFontContent);
                } else {
                    // å·²æœ‰styleæ ‡ç­¾ï¼Œç›´æ¥æ¢å¤åŸå†…å®¹
                    iframehtml = iframehtml.replace(font_placeholder, hiddenFontContent);
                }

                console.log("ğŸš€ ~  ~ hexColorObj!!:", hexColorObj)


                
                iframehtml = iframehtml.replace(/(cornflowerblue|mediumspringgreen|lightgoldenrodyellow|blanchedalmond)/g, 
                    (match) => {
                        const [prop, index] = placeholders[match];
                        placeholders[match][1]++; // æ›´æ–°ç´¢å¼•è®¡æ•°
                        return hexColorObj[prop][index];
                    }
                );
                iframehtml = iframehtml.replace(new RegExp(escapeRegExp(zwnj_placeholder), 'g'), '&zwnj;')
                return iframehtml
            }
            // å·¥å…·å‡½æ•°-è½¬ä¹‰æ­£åˆ™ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
            }

            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            submitButton.onclick = async () => {
                LoadingModule.show()
                html_doc = dataInput.value;
                // ç¦ç”¨è¾“å…¥æ¡†
                dataInput.disabled = true;
                dataInput.style.backgroundColor = '#f5f5f5';
                dataInput.style.cursor = 'not-allowed';
                // ç¦ç”¨ä¸€é”®æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æŒ‰é’®
                submitButton.disabled = true;
                submitButton.style.setProperty('background', '#ccc', 'important');;
                submitButton.style.cursor = 'not-allowed';
                toPlaceholder()
                handleOutput()
                const html_doc_promise = await new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('iframeåŠ è½½å®Œæˆ');
                        // æ‰§è¡Œä»£ç >>>>>>>>>>>>>>>>>
                        // æ˜¯å¦æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æ ·å¼ä»£ç 
                        if (showVersionInfoCheckbox.checked) {
                            addVersionInfo()
                            addVersionInfo_sosumi()
                            addVersionInfo_custom()
                        }
                        
                        let iframeHtml = iframeDoc.documentElement.outerHTML;

                        if (showVersionInfoCheckbox.checked) {
                            iframeHtml = addVersionInfoToggle(iframeHtml);
                            // é‡æ–°å†™å…¥iframe
                            iframeDoc.open();
                            iframeDoc.write(iframeHtml);
                            iframeDoc.close();
                        }

                        if (showAltCheckbox.checked) {
                            iframeHtml = iframeDoc.documentElement.outerHTML; // é‡æ–°è·å–
                            iframeHtml = addAltTextDisplay(iframeHtml);
                            // é‡æ–°å†™å…¥iframe
                            iframeDoc.open();
                            iframeDoc.write(iframeHtml);
                            iframeDoc.close();
                        }
                        
                        // showMessage({ msg: 'ç‰ˆæœ¬ä¿¡æ¯æ·»åŠ å®Œæˆï¼', type: 'success' })
                        LoadingModule.hide()
                        resolve(html_doc)
                    }, 0)
                })
                html_doc = html_doc_promise
            }
            outputButton.onclick = () => {
                // ç¦ç”¨ç”ŸæˆCodeæŒ‰é’®
                outputButton.disabled = true;
                outputButton.style.setProperty('background', '#ccc', 'important');
                outputButton.style.cursor = 'not-allowed';
                
                // å»é™¤tbody
                const tbodies = iframeDoc.querySelectorAll('tbody');
                tbodies.forEach(tbody => {
                    while (tbody.firstChild) {
                        tbody.parentNode.insertBefore(tbody.firstChild, tbody);
                    }
                    tbody.parentNode.removeChild(tbody);
                });
                // å»é™¤å ä½ç¬¦
                let iframeOutHtml = iframeDoc.documentElement.outerHTML
                iframeOutHtml = delPlaceholder(iframeOutHtml)
                
                // æ¢å¤<!DOCTYPEå‰é¢çš„å†…å®¹
                dataOutput.value = dynamicContent + '<!DOCTYPE html>' + iframeOutHtml;
                console.log("ğŸš€ ~ è¾“å‡ºçš„ ~ iframeDoc:", iframeDoc.documentElement);


            }
            copyButton.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(dataOutput.value);
                    showMessage({ msg: 'å¤åˆ¶æˆåŠŸï¼', type: 'success' })
                } catch (err) {
                    console.error(err);
                }
            }
            resetButton.onclick = () => {

                
                // æ¸…ç©ºæ‰€æœ‰å˜é‡
                hiddenPreContent = '';
                hiddenFontContent = '';
                hexColorObj = { ...originalHexColorObj };
                html_doc = '';
                
                // æ¸…ç©ºè¾“å…¥è¾“å‡ºæ¡†
                dataInput.value = '';
                dataOutput.value = '';
                
                // å¯ç”¨è¾“å…¥æ¡†
                dataInput.disabled = false;
                dataInput.style.backgroundColor = '';
                dataInput.style.cursor = '';
                

                
                // åˆ·æ–°iframe
                handleOutput();
                
                // åˆ·æ–°é¡µé¢
                window.location.reload();
                window.history.go(0);
            }

            // function
            function handleOutput() {
                iframeDoc.open();
                iframeDoc.write(html_doc);
                iframeDoc.close();
            }
        
            // ç»™å«æœ‰åŠ¨æ€ç‰ˆæœ¬ä¿¡æ¯çš„å…ƒç´ æ·»åŠ è¾¹æ¡†æ ·å¼ä»¥åŠç‰ˆæœ¬æ ‡è¯†
            function addVersionInfo() {
                // è·å–iframeä¸­çš„HTMLå†…å®¹
                let htmlContent = iframeDoc.documentElement.outerHTML;
                
                // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åŠ¨æ€ç‰ˆæœ¬ä¿¡æ¯
                // åŒ¹é…æ ¼å¼: <!-- <dmc-dynamic>#if ( $cohort == "x" || $cohort == "y" || ... ) </dmc-dynamic> --> å…ƒç´  <!-- <dmc-dynamic>#end</dmc-dynamic> -->
                const dmcRegex = new RegExp('<!--\\s*<dmc-dynamic>#if\\s*\\(\\s*((?:' + cohortVarName.replace(/\$/g, '\\$') + '\\s*==\\s*"[^"]+"\\s*(?:\\|\\|\\s*)?)+).*?<\\/dmc-dynamic>\\s*-->([\\s\\S]*?)<!--\\s*<dmc-dynamic>#end<\\/dmc-dynamic>\\s*-->', 'g');
                
                // æå–cohortå€¼çš„æ­£åˆ™è¡¨è¾¾å¼
                const cohortValueRegex = getCohortValueRegex();
                
                // åŒ¹é…å…ƒç´ æ ‡ç­¾çš„æ­£åˆ™è¡¨è¾¾å¼
                const elementRegex = /<([a-zA-Z][a-zA-Z0-9]*)\s+([^>]*)>/;
                
                // åŒ¹é…træ ‡ç­¾çš„æ­£åˆ™è¡¨è¾¾å¼
                const trRegex = /<tr\s*([^>]*)>([\s\S]*?)<\/tr>/i;
                
                // åŒ¹é…tdæ ‡ç­¾çš„æ­£åˆ™è¡¨è¾¾å¼
                const firstTdRegex = /<td\s*([^>]*)>/i;
                
                // æ›¿æ¢åŒ¹é…åˆ°çš„å†…å®¹
                htmlContent = htmlContent.replace(dmcRegex, (match, cohortCondition, elementContent) => {
                    // æå–æ‰€æœ‰cohortå€¼ï¼ˆæ’é™¤"all"ï¼‰
                    let cohorts = [];
                    let cohortMatch;
                    while ((cohortMatch = cohortValueRegex.exec(cohortCondition)) !== null) {
                        if (cohortMatch[1] !== "all") {
                            cohorts.push(cohortMatch[1]);
                        }
                    }
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„cohortå€¼ï¼Œç›´æ¥è¿”å›åŸå†…å®¹
                    if (cohorts.length === 0) {
                        return match;
                    }

                    // // å¯èƒ½éœ€è¦å¼€å‘çš„å†…å®¹(åªå–å‰ä¸¤ä½,ç‰ˆæœ¬å·ä¸æ˜¾ç¤º)ï¼Œæš‚æ—¶æ³¨é‡Šæ‰ä¸åŠ 
                    // cohorts = cohorts.map(cohort => {
                    //     let new_cohort
                    //     if (cohort.length === 3){
                    //         new_cohort = cohort.slice(1,3)
                    //     }
                    //     return new_cohort
                    // });
                    
                    // ç”Ÿæˆversion-labelå€¼
                    const versionLabel = cohorts.join(' | ');
                    
                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦æ˜¯træ ‡ç­¾
                    const trMatch = elementContent.match(trRegex);
                    if (trMatch) {
                        // å¦‚æœæ˜¯træ ‡ç­¾ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªtdæ ‡ç­¾
                        const trContent = trMatch[2]; // træ ‡ç­¾å†…çš„å†…å®¹
                        const tdMatch = trContent.match(firstTdRegex);
                        
                        if (tdMatch) {
                            // è·å–tdçš„å±æ€§éƒ¨åˆ†
                            let tdAttrs = tdMatch[1] || '';
                            
                            // æ·»åŠ isvç±»å
                            if (tdAttrs.includes('class="')) {
                                // å¦‚æœå·²æœ‰classå±æ€§ï¼Œæ£€æŸ¥æ˜¯å¦å·²åŒ…å«isvç±»
                                if (!tdAttrs.includes('class="isv"') && !tdAttrs.includes(' isv"') && !tdAttrs.includes(' isv ')) {
                                    // æ·»åŠ isvç±»åˆ°ç°æœ‰classå±æ€§
                                    tdAttrs = tdAttrs.replace(/class="([^"]*)"/g, 'class="$1 isv"');
                                }
                            } else {
                                // æ²¡æœ‰classå±æ€§ï¼Œæ·»åŠ ä¸€ä¸ª
                                tdAttrs += ' class="isv"';
                            }
                            
                            // æ·»åŠ version-labelå±æ€§
                            if (!tdAttrs.includes('version-label="')) {
                                tdAttrs += ` version-label="${versionLabel}"`;
                            }
                            
                            // æ›¿æ¢ç¬¬ä¸€ä¸ªtdæ ‡ç­¾
                            const modifiedTrContent = trContent.replace(firstTdRegex, `<td ${tdAttrs}>`);
                            const modifiedElementContent = elementContent.replace(trRegex, `<tr ${trMatch[1]}>${modifiedTrContent}</tr>`);
                            
                            // è¿”å›ä¿®æ”¹åçš„å†…å®¹ï¼Œåˆ é™¤åŠ¨æ€ä»£ç æ³¨é‡Š
                            return modifiedElementContent;
                        }
                    }
                    
                    // å¯¹äºétrå…ƒç´ æˆ–æ²¡æœ‰tdå­å…ƒç´ çš„trï¼Œä½¿ç”¨åŸæ¥çš„å¤„ç†æ–¹å¼
                    const elemMatch = elementContent.match(elementRegex);
                    if (elemMatch) {
                        const tagName = elemMatch[1];
                        let attributes = elemMatch[2];
                        
                        // æ£€æŸ¥æ˜¯å¦å·²æœ‰classå±æ€§
                        if (attributes.includes('class="')) {
                            // å¦‚æœå·²æœ‰classå±æ€§ï¼Œæ£€æŸ¥æ˜¯å¦å·²åŒ…å«isvç±»
                            if (attributes.includes('class="isv"') || attributes.includes(' isv"') || attributes.includes(' isv ')) {
                                // å·²æœ‰isvç±»ï¼Œä¸éœ€è¦æ·»åŠ 
                            } else {
                                // æ·»åŠ isvç±»åˆ°ç°æœ‰classå±æ€§
                                attributes = attributes.replace(/class="([^"]*)"/g, 'class="$1 isv"');
                            }
                        } else {
                            // æ²¡æœ‰classå±æ€§ï¼Œæ·»åŠ ä¸€ä¸ª
                            attributes += ' class="isv"';
                        }
                        
                        // æ·»åŠ version-labelå±æ€§
                        if (!attributes.includes('version-label="')) {
                            attributes += ` version-label="${versionLabel}"`;
                        }
                        
                        // æ›¿æ¢å¼€å§‹æ ‡ç­¾ï¼Œä¿ç•™å…¶ä½™éƒ¨åˆ†
                        const modifiedElementContent = elementContent.replace(elementRegex, `<${tagName} ${attributes}>`);
                        
                        // è¿”å›ä¿®æ”¹åçš„å†…å®¹ï¼Œåˆ é™¤åŠ¨æ€ä»£ç æ³¨é‡Š
                        return modifiedElementContent;
                    }
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å…ƒç´ æ ‡ç­¾ï¼Œç›´æ¥è¿”å›å…ƒç´ å†…å®¹
                    return elementContent;
                });
                
                // æ›´æ–°html_docå¹¶é‡æ–°æ¸²æŸ“
                html_doc = htmlContent;
                handleOutput();
                
                console.log("ç‰ˆæœ¬ä¿¡æ¯æ·»åŠ å®Œæˆï¼ŒåŠ¨æ€ä»£ç å·²åˆ é™¤");
            }

            function addVersionInfo_sosumi() {
                // è·å–iframeä¸­çš„HTMLå†…å®¹
                let htmlContent = iframeDoc.documentElement.outerHTML;
                
                // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å«æœ‰æ¡ä»¶åˆ¤æ–­çš„pæ ‡ç­¾
                // å°†pæ ‡ç­¾åˆ†ä¸ºå¼€å§‹æ ‡ç­¾ã€æ¡ä»¶åˆ¤æ–­éƒ¨åˆ†ã€å†…å®¹éƒ¨åˆ†ã€ç»“æŸæ ‡ç­¾å’Œç»“æŸpæ ‡ç­¾
                const sosumiRegex = /(<p\s+[^>]*>)(#if\s*\(\s*(?:\$cohort\s*==\s*"[^"]+"\s*(?:\|\|\s*)?)+\s*\))([\s\S]*?)(#end)(<\/p>)/g;
                
                // æå–cohortå€¼çš„æ­£åˆ™è¡¨è¾¾å¼
                const cohortValueRegex = getCohortValueRegex();
                
                // æ›¿æ¢åŒ¹é…åˆ°çš„å†…å®¹
                htmlContent = htmlContent.replace(sosumiRegex, (match, pOpen, ifCondition, content, endTag, pClose) => {
                    // æå–æ‰€æœ‰cohortå€¼ï¼ˆæ’é™¤"all"ï¼‰
                    const cohorts = [];
                    let cohortMatch;
                    const cohortCondition = ifCondition;
                    
                    while ((cohortMatch = cohortValueRegex.exec(cohortCondition)) !== null) {
                        if (cohortMatch[1] !== "all") {
                            cohorts.push(cohortMatch[1]);
                        }
                    }
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„cohortå€¼ï¼Œç›´æ¥è¿”å›åŸå†…å®¹
                    if (cohorts.length === 0) {
                        console.log("ğŸš€ ~ sosumi - æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„cohortå€¼ï¼Œç›´æ¥è¿”å›åŸå†…å®¹");
                        return match;
                    }
                    
                    // ç”Ÿæˆversion-labelå€¼
                    const versionLabel = cohorts.join(' | ');
                    
                    // æ£€æŸ¥pæ ‡ç­¾æ˜¯å¦å·²æœ‰classå±æ€§
                    if (pOpen.includes('class="')) {
                        // å¦‚æœå·²æœ‰classå±æ€§ï¼Œæ£€æŸ¥æ˜¯å¦å·²åŒ…å«isvç±»
                        if (pOpen.includes('class="isv"') || pOpen.includes(' isv"') || pOpen.includes(' isv ')) {
                            // å·²æœ‰isvç±»ï¼Œä¸éœ€è¦æ·»åŠ 
                        } else {
                            // æ·»åŠ isvç±»åˆ°ç°æœ‰classå±æ€§
                            pOpen = pOpen.replace(/class="([^"]*)"/g, 'class="$1 isv"');
                        }
                    } else {
                        // æ²¡æœ‰classå±æ€§ï¼Œæ·»åŠ ä¸€ä¸ª
                        pOpen = pOpen.replace(/<p\s+/, '<p class="isv" ');
                    }
                    
                    // æ·»åŠ version-labelå±æ€§
                    if (!pOpen.includes('version-label="')) {
                        pOpen = pOpen.replace(/<p\s+/, `<p version-label="${versionLabel}" `);
                    }
                    // è¿”å›ä¿®æ”¹åçš„æ ‡ç­¾
                    // return pOpen + ifCondition + content + endTag + pClose;
                    // è¿”å›ä¿®æ”¹åçš„æ ‡ç­¾ï¼Œåˆ é™¤åŠ¨æ€ä»£ç ï¼ˆ#ifåˆ°#endï¼‰ï¼Œåªä¿ç•™å†…å®¹éƒ¨åˆ†
                    return pOpen + content.trim() + pClose;
                });
                
                // æ›´æ–°html_docå¹¶é‡æ–°æ¸²æŸ“
                html_doc = htmlContent;
                handleOutput();
                
                console.log("sosumiç‰ˆæœ¬ä¿¡æ¯æ·»åŠ å®Œæˆï¼ŒåŠ¨æ€ä»£ç å·²åˆ é™¤");
            }

            function addVersionInfo_custom() {
                // å¦‚æœä»£ç ä¸­çš„h1,h2,h3,h4,h5,h6,pæ ‡ç­¾ä¸­å«æœ‰ç±»ä¼¼#if( $cohort == "2" || $cohort == "3" || $cohort == "4" || $cohort == "12" || $cohort == "13" || $cohort == "17" || $cohort == "18") å¹¶ä¸”ä»¥#endç»“å°¾çš„åŠ¨æ€ä»£ç ï¼Œåˆ™å°†åŠ¨æ€ä»£ç çš„å†…éƒ¨æ·»åŠ ä¸€ä¸ªspanæ ‡ç­¾ï¼ŒåŒ…è£¹åŠ¨æ€ä»£ç çš„å†…éƒ¨å†…å®¹ï¼Œspanæ ‡ç­¾çš„classä¸ºisvï¼Œversion-labelä¸ºåŠ¨æ€ä»£ç ä¸­çš„cohortå€¼
                
                // è·å–iframeä¸­çš„HTMLå†…å®¹
                let htmlContent = iframeDoc.documentElement.outerHTML;
                
                // å…ˆæ‰¾å‡ºæ‰€æœ‰çš„h1-h6å’Œpæ ‡ç­¾
                const headingParaTagRegex = /(<(h[1-6]|p)\s*[^>]*>)([\s\S]*?)(<\/\2>)/gi;
                
                // æå–cohortå€¼çš„æ­£åˆ™è¡¨è¾¾å¼
                const cohortValueRegex = getCohortValueRegex();
                
                // æ›¿æ¢åŒ¹é…åˆ°çš„æ ‡ç­¾å†…å®¹
                htmlContent = htmlContent.replace(headingParaTagRegex, (match, openTag, tagName, content, closeTag) => {
                    // æ£€æŸ¥æ ‡ç­¾å†…å®¹æ˜¯å¦åŒ…å«åŠ¨æ€ä»£ç 
                    if (!content.includes('#if') || !content.includes('#end')) {
                        return match; // ä¸åŒ…å«åŠ¨æ€ä»£ç ï¼Œç›´æ¥è¿”å›åŸå†…å®¹
                    }
                    
                    console.log("å¤„ç†æ ‡ç­¾:", tagName, "å†…å®¹é•¿åº¦:", content.length);
                    
                    // åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥å¤„ç†åŠ¨æ€ä»£ç 
                    function processContent(text) {
                        // åŒ¹é…åŠ¨æ€ä»£ç çš„æ­£åˆ™è¡¨è¾¾å¼ - ä¿®æ”¹ä¸ºå¤„ç†è¿ç»­çš„åŠ¨æ€ä»£ç å—
                        // æ ¼å¼: #if( $cohort == "x" )å†…å®¹#end å¯èƒ½ç´§è·Ÿç€ #if( $cohort == "y" )å†…å®¹#end
                        const dynamicCodeRegex = /#if\s*\(\s*(\$cohort\s*==\s*"[^"]+")[\s\S]*?\)([\s\S]*?)#end/g;
                        
                        let result = text;
                        let matches = [];
                        let match;
                        
                        // æ”¶é›†æ‰€æœ‰åŒ¹é…é¡¹
                        while ((match = dynamicCodeRegex.exec(text)) !== null) {
                            matches.push({
                                fullMatch: match[0],
                                cohortCondition: match[1],
                                dynamicContent: match[2],
                                index: match.index,
                                length: match[0].length
                            });
                        }
                        
                        // ä»åå‘å‰æ›¿æ¢ï¼Œé¿å…ç´¢å¼•å˜åŒ–é—®é¢˜
                        for (let i = matches.length - 1; i >= 0; i--) {
                            const m = matches[i];
                            
                            // æå–cohortå€¼
                            const cohortMatch = m.cohortCondition.match(/\$cohort\s*==\s*"([^"]+)"/);
                            if (!cohortMatch) continue;
                            
                            const cohortValue = cohortMatch[1];
                            if (cohortValue === "all") continue;
                            
                            // åˆ›å»ºåŒ…è£¹å†…å®¹çš„spanæ ‡ç­¾
                            const wrappedContent = `<span class="isv" style="display: inline-block;" version-label="${cohortValue}">${m.dynamicContent}</span><br>`;
                            
                            // æ›¿æ¢åŠ¨æ€ä»£ç 
                            result = result.substring(0, m.index) + wrappedContent + result.substring(m.index + m.length);
                        }
                        
                        return result;
                    }
                    
                    // å¤„ç†æ ‡ç­¾å†…å®¹ä¸­çš„åŠ¨æ€ä»£ç 
                    const modifiedContent = processContent(content);
                    
                    // è¿”å›ä¿®æ”¹åçš„æ ‡ç­¾
                    return openTag + modifiedContent + closeTag;
                });
                
                // æ›´æ–°html_docå¹¶é‡æ–°æ¸²æŸ“
                html_doc = htmlContent;
                handleOutput();
                
                console.log("æ ‡é¢˜å’Œæ®µè½ä¸­çš„æ‰€æœ‰åŠ¨æ€ä»£ç å¤„ç†å®Œæˆ");
            }

            // æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º/éšè—æŒ‰é’®åŠŸèƒ½
            function addVersionInfoToggle(htmlContent) {
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºé¡¶éƒ¨åˆ‡æ¢æŒ‰é’®
                const showTopButton = showTopToggleButtonCheckbox.checked;
                
                // 1. æ·»åŠ CSSæ ·å¼å’Œcheckbox hackæ§åˆ¶å™¨
                const versionToggleStyles = `
    <style name="dmc-version-toggle">
        /* éšè—checkbox */
        #toggleVersionInfo {
            display: none;
        }
        
        /* åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .version-toggle-btn {
            display: ${showTopButton ? 'block' : 'none'};
            margin: 1rem auto;
            width: 10rem;
            border-radius: 6rem;
            text-align: center;
            padding: 0.8rem 0.6rem;
            color: #fff;
            background-color: #0071e3;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .version-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        /* æŒ‰é’®æ–‡å­—åˆ‡æ¢ */
        .version-toggle-btn::before {
            content: "Show DM versions";
        }
        
        #toggleVersionInfo:checked ~ .version-toggle-btn::before {
            content: "Hide DM versions";
        }
        
        /* é»˜è®¤éšè—ç‰ˆæœ¬ä¿¡æ¯æ ·å¼ */
        .isv {
            border: none !important;
        }
        
        .isv::after {
            display: none !important;
        }
        
        /* å½“checkboxè¢«é€‰ä¸­æ—¶æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯æ ·å¼ */
        #toggleVersionInfo:checked ~ * .isv {
            position: relative;
            border: 2px dashed red !important;
            box-sizing: border-box;
        }
        
        #toggleVersionInfo:checked ~ * .isv::after {
            content: attr(version-label);
            position: absolute;
            bottom: 0px;
            right: 0px;
            transform: translate(0, 0);
            height: 16px;
            padding: 0 16px;
            background: #ff6b6b;
            color: white;
            font-size: 12px;
            font-weight: bold;
            border-radius: 18px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease 0.3s;
            cursor: pointer;
        }
        
        #toggleVersionInfo:checked ~ * .isv:hover::after {
            opacity: 0;
        }
    </style>`;
                
                // 2. åœ¨<head>æ ‡ç­¾ä¸­æ’å…¥æ ·å¼
                htmlContent = htmlContent.replace('</head>', versionToggleStyles + '\n</head>');
                
                // 3. åœ¨<body>æ ‡ç­¾åç«‹å³æ·»åŠ checkboxå’Œåˆ‡æ¢æŒ‰é’®
                const toggleControl = `
    <input type="checkbox" id="toggleVersionInfo" checked>
    <label for="toggleVersionInfo" class="version-toggle-btn"></label>
`;
                htmlContent = htmlContent.replace(/<body([^>]*)>/, `<body$1>\n${toggleControl}`);
                
                console.log("ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º/éšè—æŒ‰é’®å·²æ·»åŠ ");
                return htmlContent;
            }

            // æ·»åŠ Altæ–‡æœ¬æ˜¾ç¤ºåŠŸèƒ½
            function addAltTextDisplay(htmlContent) {
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºé¡¶éƒ¨åˆ‡æ¢æŒ‰é’®
                const showTopButton = showTopToggleButtonCheckbox.checked;
                
                // 1. æ·»åŠ CSSæ ·å¼å’Œcheckbox hackæ§åˆ¶å™¨
                const altDisplayStyles = `
    <style name="dmc-alt-display">
        /* éšè—checkbox */
        #toggleAltText {
            display: none;
        }
        
        /* åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .alt-toggle-btn {
            display: ${showTopButton ? 'block' : 'none'};
            margin: 1rem auto;
            width: 10rem;
            border-radius: 6rem;
            text-align: center;
            padding: 0.8rem 0.6rem;
            color: #fff;
            background-color: #0071e3;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .alt-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        /* æŒ‰é’®æ–‡å­—åˆ‡æ¢ */
        .alt-toggle-btn::before {
            content: "Show image ALTs";
        }
        
        #toggleAltText:checked ~ .alt-toggle-btn::before {
            content: "Hide image ALTs";
        }
        
        /* Altæ–‡æœ¬æ˜¾ç¤ºå…ƒç´ æ ·å¼ - é»˜è®¤éšè— */
        .img-alt-text {
            display: none;
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: #ffdddd;
           /* border-left: 4px solid #667eea; */
            border-radius: 4px;
            color: red !important;
            font-size: 13px;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* å½“checkboxè¢«é€‰ä¸­æ—¶æ˜¾ç¤ºaltæ–‡æœ¬ */
        #toggleAltText:checked ~ * .img-alt-text {
            display: block !important;
        }
        
        /* å›¾ç‰‡å®¹å™¨æ ·å¼ */
        .img-with-alt {
            display: block;
            margin-bottom: 4px;
        }
    </style>`;
                
                // 2. åœ¨<head>æ ‡ç­¾ä¸­æ’å…¥æ ·å¼
                htmlContent = htmlContent.replace('</head>', altDisplayStyles + '\n</head>');
                
                // 3. ç»™æ‰€æœ‰æœ‰altå±æ€§çš„imgæ ‡ç­¾æ·»åŠ classå¹¶åœ¨åé¢æ’å…¥altæ–‡æœ¬æ˜¾ç¤ºå…ƒç´ 
                htmlContent = htmlContent.replace(/<img([^>]*?)alt="([^"]*)"([^>]*?)>/gi, (match, before, altText, after) => {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
                    if (match.includes('img-with-alt')) {
                        return match;
                    }
                    
                    // å¤„ç†imgæ ‡ç­¾ï¼Œæ·»åŠ class
                    let imgTag = match;
                    if (before.includes('class="') || after.includes('class="')) {
                        // åœ¨ç°æœ‰classä¸­æ·»åŠ img-with-alt
                        imgTag = match.replace(/class="([^"]*)"/i, 'class="$1 img-with-alt"');
                    } else {
                        // æ·»åŠ æ–°çš„classå±æ€§
                        imgTag = `<img${before}alt="${altText}"${after} class="img-with-alt">`;
                    }
                    
                    // åœ¨imgæ ‡ç­¾åé¢æ·»åŠ æ˜¾ç¤ºaltæ–‡æœ¬çš„div
                    const altTextDiv = `<div class="img-alt-text">${altText}</div>`;
                    
                    return imgTag + altTextDiv;
                });
                
                // 4. åœ¨<body>æ ‡ç­¾åç«‹å³æ·»åŠ checkboxå’Œåˆ‡æ¢æŒ‰é’®
                const toggleControl = `
    <input type="checkbox" id="toggleAltText" checked>
    <label for="toggleAltText" class="alt-toggle-btn"></label>
`;
                htmlContent = htmlContent.replace(/<body([^>]*)>/, `<body$1>\n${toggleControl}`);
                
                console.log("Altæ–‡æœ¬æ˜¾ç¤ºåŠŸèƒ½å·²æ·»åŠ ");
                return htmlContent;
            }
        });
    </script>
</body>

</html>