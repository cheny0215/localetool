<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€é”®QA</title>
    <link rel="stylesheet" href="../common/layui/css/layui.css" />
    <link rel="stylesheet" href="../css/index.css">
    <script src="../common/layui/layui.js"></script>
    <script src="../common/components/ShowMessage.js" defer></script>
    <script src="../common/components/Loading.js" defer></script>
    <style>
        .alpineData {
            font-size: 14px;
            color: #333;
            display: flex;
            padding: 8px;
        }

        .leftAlpineBox {
            flex: 3;
            padding: 20px;
            border-radius: 6px;
        }

        .centerAlpineBox {
            padding: 20px;
            flex: 3;
            margin: 0 12px;
            border-radius: 6px;
        }

        .centerAlpineBox .layui-form-checkbox {
            margin-bottom: 4px;
        }

        .rightAlpineBox {
            padding: 20px;
            flex: 3;
            border-radius: 6px;
        }

        .data_textarea {
            resize: both;
            border: 1px solid #c2c2c2;
            border-radius: 4px;
        }

        .data_textarea::placeholder {
            color: #ccc;
        }

        .layui-btn {
            height: 36px;
            line-height: 36px;
            padding: 0 16px;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            transform: perspective(800px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .layui-btn-sm {
            margin: 6px 0;
            font-weight: 700;
            border-radius: 8px;
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
        }

        .laybox {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>

<body>
    <div class="alpineData">
        <div class="leftAlpineBox layui-panel">
            <div class="tweHtml">
                <h4 style="color: #0880ea;">åŸå§‹htmlï¼š</h4>
                <hr>
                <textarea id="dataInput" class="data_textarea layui-textarea" placeholder="êš°êš°êš° å°†åŸå§‹HTMLä»£ç ç²˜è´´åˆ°è¿™é‡Œ êš°êš°êš°"></textarea>
                <div>
                    <iframe id="myIframe" src="" frameborder="0"
                        style="width: 100%;border: 1px solid #d8d8d8;margin-top: 10px;"></iframe>
                    <div style="margin-top: 8px; color: #ff4d50ca; font-size: 12px;">
                        <i class="layui-icon layui-icon-notice" style="font-size: 14px;"></i>
                        æ¯ä½¿ç”¨ä¸€æ¬¡åï¼Œè¯·åˆ·æ–°é¡µé¢é˜²æ­¢ç¼“å­˜ï¼Œå†è¿›è¡Œä¸‹ä¸€æ¬¡ä½¿ç”¨
                    </div>
                    <div style="margin-top: 4px; color: #ff7847d3; font-size: 12px;">
                        <i class="layui-icon layui-icon-notice" style="font-size: 14px;"></i>
                        å»ºè®®QAä¹‹å‰å¤‡ä»½åŸå§‹htmlï¼Œä»£ç æ·»åŠ åè¿›è¡Œé¡µé¢å¯¹æ¯”ï¼Œç¡®ä¿ä¸€è‡´
                    </div>
                </div>
            </div>
        </div>
        <div class="centerAlpineBox layui-panel">
            <div class="layui-form laybox">
                <input type="checkbox" id="allSelectCheckbox" name="allSelect" title="å…¨é€‰" checked
                    lay-filter="checkbox-allSelect">
                <hr>
                <input type="checkbox" id="addMarginCheckbox" name="addMargin" title="hæ ‡ç­¾pæ ‡ç­¾åŠ margin" checked>
                <input type="checkbox" id="delUnderlineCheckbox" name="delUnderline" title="aæ ‡ç­¾å»æ‰ä¸‹åˆ’çº¿" checked>
                <input type="checkbox" id="replaceFontFamilyCheckbox" name="replaceFontFamily" title="æ›¿æ¢æ‰€æœ‰font-family"
                    checked>
                <input type="checkbox" id="tableFontFamilyCheckbox" name="tableFontFamily" title="ç¬¬ä¸€ä¸ªtableæ·»åŠ font-family"
                    checked>
                <input type="checkbox" id="replacePreNbspCheckbox" name="replacePreNbsp" title="æ›¿æ¢preview-copyä¸­çš„nbsp"
                    checked>
                <input type="checkbox" id="delNbspCheckbox" name="delNbsp" title="æ›¿æ¢footerçš„æœ€åä¸¤ä¸ªnbsp" checked>
                <input type="checkbox" id="del414MediaCheckbox" name="del414Media" title="å»é™¤414åª’ä½“æŸ¥è¯¢" checked>
                <input type="checkbox" id="legalPackageCheckbox" name="legalPackage" title="åŒ…è£¹legalæœ«å°¾é˜²æ­¢å•å­—" checked>
                <input type="checkbox" id="replacepSelectorCheckbox" name="replacepSelector" title="æ›¿æ¢cssä¸­>pé€‰æ‹©å™¨"
                    checked>
                <input type="checkbox" id="imgToCenterCheckbox" name="imgToCenter" title="imgå›¾ç‰‡è®¾ç½®å±…ä¸­" checked>
                <input type="checkbox" id="addDateZwnjCheckbox" name="addDateZwnj" title="æ—¥æœŸé—´æ·»åŠ zwnj" checked>
                <input type="checkbox" id="appStoreNowrapCheckbox" name="addDateZwnj" title="footerä¸‹è½½appStoreä¸æ¢è¡Œ"
                    checked>
                <hr>
                <div>
                    <input type="checkbox" id="supNormalSizeCheckbox" name="supNormalSize"
                        title="sinaé‚®ç®±ç§»åŠ¨ç«¯æ·»åŠ supæ ·å¼"><span class="layui-badge-rim layui-border-blue">sinaé‚®ç®±/CN</span>
                </div>
                <div>
                    <input type="checkbox" id="setNowrapSpanCheckbox" name="setNowrapSpan"
                        title="mobileç½‘æ˜“spanè®¾ç½®nowrapå±æ€§"><span class="layui-badge-rim layui-border-blue">163é‚®ç®±/CN</span>
                </div>
                <div>
                    <input type="checkbox" id="delUnderlineImportantCheckbox" name="delUnderlineImportant"
                        title="desktopå»é™¤ä¸‹åˆ’çº¿çš„!important"><span class="layui-badge-rim layui-border-blue">CN</span>
                </div>
                <hr>
            </div>
            <div class="layui-btn-container">
                <button id="submitButton"
                    class="layui-btn layui-btn-sm  layui-bg-blue layui-icon layui-icon-component"> ä¸€é”®æ·»åŠ QA âŠ</button>
                <button id="outputButton"
                    class="layui-btn layui-btn-sm  layui-bg-blue layui-icon layui-icon-fonts-code"> ç”ŸæˆCode â‹</button>
            </div>
        </div>
        <div class="rightAlpineBox layui-panel">
            <h4 style="color: #0880ea;">QAåhtmlï¼š</h4>
            <hr>
            <textarea id="dataOutput" class="data_textarea layui-textarea" placeholder="ç”Ÿæˆä»£ç ä¹‹åï¼Œç‚¹å‡» â˜Ÿâ˜Ÿä¸‹æ–¹æŒ‰é’®å¤åˆ¶ä»£ç ï¼Œå¹¶ç²˜è´´å›åŸå§‹htmlæ–‡ä»¶ ãŠ—ï¸ãŠ—ï¸ãŠ—ï¸"></textarea>
            <hr>
            <div class="layui-btn-container">
                <button id="copyButton"
                    class="layui-btn layui-btn-sm  layui-bg-blue layui-icon layui-icon-file-b"> å¤åˆ¶ä»£ç  âŒ</button>
                <button id="resetButton"
                    class="layui-btn layui-btn-sm  layui-bg-blue layui-icon layui-icon-refresh"> åˆ·æ–°é¡µé¢ â</button>
            </div>
        </div>
    </div>
    <script>
        // æ•°æ®åº“
        const langArr = [
            { lang: 'zh-HK', font: "font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'SFNSText', 'PingFang HK', 'STHeiti', 'Helvetica Neue', Helvetica, 'å¾®è»Ÿæ­£é»‘é«”Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«” Microsoft JhengHei', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', 'MingLiU', Arial, sans-serif, 'SF Pro Icons'!important;" },
            { lang: 'zh-TW', font: "font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'SFNSText', 'PingFang TC', 'STHeiti', 'Helvetica Neue', Helvetica, 'å¾®è»Ÿæ­£é»‘é«”Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«” Microsoft JhengHei', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', 'MingLiU', Arial, sans-serif, 'SF Pro Icons'!important;" },
            { lang: 'zh-CN', font: "font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'SFNSText', 'PingFang SC', 'STHeiti', 'Helvetica Neue', Helvetica, 'Microsoft yahei', 'å¾®è½¯é›…é»‘', Arial, sans-serif, 'SF Pro Icons'!important;" },
            { lang: 'en-HK', font: "font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif, 'SF Pro Icons'!important;" },
        ]

        // #region
        const preCopyNbsp = `
        &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp;â€Œâ€Œâ€Œ&nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp; â € &nbsp;â€Œâ€Œâ€Œ
        `
        // #endregion

        document.addEventListener('DOMContentLoaded', function () {
            const dataInput = document.getElementById('dataInput');
            const dataOutput = document.getElementById('dataOutput');
            const iframe = document.getElementById('myIframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            // Checkbox element
            const allSelectCheckbox = document.getElementById('allSelectCheckbox');
            const addMarginCheckbox = document.getElementById('addMarginCheckbox');
            const delUnderlineCheckbox = document.getElementById('delUnderlineCheckbox');
            const replaceFontFamilyCheckbox = document.getElementById('replaceFontFamilyCheckbox');
            const tableFontFamilyCheckbox = document.getElementById('tableFontFamilyCheckbox');
            const replacePreNbspCheckbox = document.getElementById('replacePreNbspCheckbox');
            const delNbspCheckbox = document.getElementById('delNbspCheckbox');
            const del414MediaCheckbox = document.getElementById('del414MediaCheckbox');
            const legalPackageCheckbox = document.getElementById('legalPackageCheckbox');
            const replacepSelectorCheckbox = document.getElementById('replacepSelectorCheckbox');
            const imgToCenterCheckbox = document.getElementById('imgToCenterCheckbox');
            const addDateZwnjCheckbox = document.getElementById('addDateZwnjCheckbox');
            const appStoreNowrapCheckbox = document.getElementById('appStoreNowrapCheckbox');

            const supNormalSizeCheckbox = document.getElementById('supNormalSizeCheckbox');
            const setNowrapSpanCheckbox = document.getElementById('setNowrapSpanCheckbox');
            const delUnderlineImportantCheckbox = document.getElementById('delUnderlineImportantCheckbox');
            // Checkbox element

            const submitButton = document.getElementById('submitButton');
            const outputButton = document.getElementById('outputButton');
            const copyButton = document.getElementById('copyButton');
            const resetButton = document.getElementById('resetButton');

            let html_doc = '';
            let hiddenPreContent = '';
            let hiddenFontContent = '';
            let dynamicContent = '';
            const originalHexColorObj = {
                addMargin: [],
                delUnderline: [],
                delUnderlineImportant: [],
                appStoreNowrap: [],
            };
            let hexColorObj = originalHexColorObj
            const placeholdersRepository = {
                    'cornflowerblue': ['addMargin', 0],
                    'mediumspringgreen': ['delUnderline', 0],
                    'lightgoldenrodyellow': ['delUnderlineImportant', 0],
                    'blanchedalmond': ['appStoreNowrap', 0]
                };
            const generateColorPlaceholder = Object.keys(placeholdersRepository)
            const pre_placeholder = '<!-- [[PRE_PLACEHOLDER]] -->';        // preview copyéƒ¨åˆ† é¢„å¤„ç†
            const font_placeholder = '<!-- [[FONT_PLACEHOLDER]] -->';      // æš‚å­˜æ³¨é‡Šçš„é‚£ä¸€å¤§æ®µå†…å®¹
            const zwnj_placeholder = '<!-- [[ZWNJ_PLACEHOLDER]] -->';        // é›¶å®½ç©ºæ ¼
            const dynamic_placeholder = '<!-- [[DYNAMIC_PLACEHOLDER]] -->';     // åŠ¨æ€å†…å®¹


            // layuiçš„ä¸€äº›æ–¹æ³•
            layui.use(function () {
                let form = layui.form;
                let layer = layui.layer;
                let util = layui.util;
                // å…¨é€‰
                form.on('checkbox(checkbox-allSelect)', function (data) {
                    const elem = data.elem; // è·å¾— checkbox åŸå§‹ DOM å¯¹è±¡
                    const checked = elem.checked; // è·å¾— checkbox é€‰ä¸­çŠ¶æ€
                    const value = elem.value; // è·å¾— checkbox å€¼
                    addMarginCheckbox.checked = elem.checked
                    delUnderlineCheckbox.checked = elem.checked
                    replaceFontFamilyCheckbox.checked = elem.checked
                    tableFontFamilyCheckbox.checked = elem.checked
                    replacePreNbspCheckbox.checked = elem.checked
                    delNbspCheckbox.checked = elem.checked
                    del414MediaCheckbox.checked = elem.checked
                    replacepSelectorCheckbox.checked = elem.checked
                    legalPackageCheckbox.checked = elem.checked
                    imgToCenterCheckbox.checked = elem.checked
                    addDateZwnjCheckbox.checked = elem.checked
                    appStoreNowrapCheckbox.checked = elem.checked
                });
            })

            // inputäº‹ä»¶
            dataInput.addEventListener('input', function () {
                html_doc = dataInput.value;
                toPlaceholder()
                handleOutput()
            });

            // å ä½ç¬¦
            function toPlaceholder() {
                html_doc = html_doc.replace(/<div style="display: none; max-height: 0px; overflow: hidden;">([\s\S]*?)<\/div>/, (match, content) => {
                    console.log("ğŸš€ ~ html_doc=html_doc.replace ~ match:", match)
                    hiddenPreContent = match; // å­˜å‚¨å†…å®¹
                    return pre_placeholder; // æ›¿æ¢ä¸ºå ä½ç¬¦
                });
                html_doc = html_doc.replace(/\<!--\[if gte mso 9\]\>([\s\S]*)\<!\[endif\]--\>/, (match, content) => {
                    hiddenFontContent = match; // å­˜å‚¨å†…å®¹
                    return font_placeholder; // æ›¿æ¢ä¸ºå ä½ç¬¦
                });
                html_doc = html_doc.replace(/&zwnj;/g, zwnj_placeholder)
                // å­˜å‚¨<!DOCTYPEå‰é¢çš„æ‰€æœ‰å†…å®¹
                html_doc = html_doc.replace(/^[\s\S]*?(?=<!DOCTYPE)/i, (match) => {
                    dynamicContent = match; // å­˜å‚¨åŒ¹é…åˆ°çš„å†…å®¹
                    return dynamic_placeholder; // æ›¿æ¢ä¸ºå ä½ç¬¦
                });
            }
            function delPlaceholder(iframehtml) {
                iframehtml = iframehtml.replace(pre_placeholder, hiddenPreContent);      // æ›¿æ¢å ä½ç¬¦ä¸ºåŸå†…å®¹
                iframehtml = iframehtml.replace(font_placeholder, hiddenFontContent);

                console.log("ğŸš€ ~  ~ hexColorObj!!:", hexColorObj)
                
                iframehtml = iframehtml.replace(new RegExp(Object.keys(placeholdersRepository   ).join('|'), 'g'), 
                    (match) => {
                        const [prop, index] = placeholdersRepository[match];
                        placeholdersRepository[match][1]++; // æ›´æ–°ç´¢å¼•è®¡æ•°
                        return hexColorObj[prop][index];
                    }
                );
                iframehtml = iframehtml.replace(new RegExp(escapeRegExp(zwnj_placeholder), 'g'), '&zwnj;')
                return iframehtml
            }
            // å·¥å…·å‡½æ•°-è½¬ä¹‰æ­£åˆ™ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
            }
            // å·¥å…·å‡½æ•°-å°†RGBè½¬æ¢ä¸ºåå…­è¿›åˆ¶
            function rgbToHex(rgb) {
                // æå– RGB å€¼
                const result = rgb.match(/\d+/g);
                if (!result) return null;
                // è½¬æ¢ä¸ºåå…­è¿›åˆ¶
                return '#' + result.map(x => {
                    const hex = parseInt(x).toString(16).padStart(2, '0'); // è½¬æ¢ä¸ºåå…­è¿›åˆ¶å¹¶è¡¥é›¶
                    return hex;
                }).join('');
            }

            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            submitButton.onclick = async () => {
                // localStorage.setItem('cy_outputButton_current_html', '')
                LoadingModule.show()
                html_doc = dataInput.value;
                // ç¦ç”¨è¾“å…¥æ¡†
                dataInput.disabled = true;
                dataInput.style.backgroundColor = '#f5f5f5';
                dataInput.style.cursor = 'not-allowed';
                // ç¦ç”¨ä¸€é”®æ·»åŠ QAæŒ‰é’®
                submitButton.disabled = true;
                submitButton.style.setProperty('background', '#ccc', 'important');;
                submitButton.style.cursor = 'not-allowed';
                toPlaceholder()
                handleOutput()
                const html_doc_promise = await new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('iframeåŠ è½½å®Œæˆ');
                        if (addMarginCheckbox.checked) {
                            addMargin();
                        }
                        if (delUnderlineCheckbox.checked) {
                            delUnderline();
                        }
                        if (replaceFontFamilyCheckbox.checked) {
                            replaceFontFamily();
                        }
                        if (tableFontFamilyCheckbox.checked) {
                            tableFontFamily();
                        }
                        if (replacePreNbspCheckbox.checked) {
                            replacePreNbsp();
                        }
                        if (delNbspCheckbox.checked) {
                            delNbsp();
                        }
                        if (del414MediaCheckbox.checked) {
                            del414Media();
                        }
                        if (legalPackageCheckbox.checked) {
                            legalPackage();
                        }
                        if (replacepSelectorCheckbox.checked) {
                            replacepSelector();
                        }
                        if (imgToCenterCheckbox.checked) {
                            imgToCenter();
                        }
                        if (addDateZwnjCheckbox.checked) {
                            addDateZwnj();
                        }
                        if (appStoreNowrapCheckbox.checked) {
                            appStoreNowrap();
                        }

                        if (supNormalSizeCheckbox.checked) {
                            supNormalSize();
                        }
                        if (setNowrapSpanCheckbox.checked) {
                            setNowrapSpan();
                        }
                        if (delUnderlineImportantCheckbox.checked) {
                            delUnderlineImportant();
                        }
                        showMessage({ msg: 'QAæ·»åŠ å®Œæˆï¼', type: 'success' })
                        LoadingModule.hide()
                        resolve(html_doc)
                    }, 0)
                })
                html_doc = html_doc_promise
            }
            outputButton.onclick = () => {
                // ç¦ç”¨ç”ŸæˆCodeæŒ‰é’®
                outputButton.disabled = true;
                outputButton.style.setProperty('background', '#ccc', 'important');
                outputButton.style.cursor = 'not-allowed';
                
                // å»é™¤tbody
                const tbodies = iframeDoc.querySelectorAll('tbody');
                tbodies.forEach(tbody => {
                    while (tbody.firstChild) {
                        tbody.parentNode.insertBefore(tbody.firstChild, tbody);
                    }
                    tbody.parentNode.removeChild(tbody);
                });
                // å»é™¤å ä½ç¬¦
                let iframeOutHtml = iframeDoc.documentElement.outerHTML
                iframeOutHtml = delPlaceholder(iframeOutHtml)
                dataOutput.value = dynamicContent + '<!DOCTYPE html>' + iframeOutHtml;
                console.log("ğŸš€ ~ è¾“å‡ºçš„ ~ iframeDoc:", iframeDoc.documentElement);

                // å­˜å‚¨åˆ°ä¼šè¯å­˜å‚¨
                const compareObj = {
                    oldHtml: dataInput.value,
                    newHtml: dataOutput.value
                }
                localStorage.setItem('cy_outputButton_current_html', JSON.stringify(compareObj))
                showMessage({ msg: 'å·²ç”Ÿæˆï¼', type: 'success' })
            }
            copyButton.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(dataOutput.value);
                    showMessage({ msg: 'å¤åˆ¶æˆåŠŸï¼', type: 'success' })
                } catch (err) {
                    console.error(err);
                }
            }
            resetButton.onclick = () => {

                
                // æ¸…ç©ºæ‰€æœ‰å˜é‡
                hiddenPreContent = '';
                hiddenFontContent = '';
                hexColorObj = {...originalHexColorObj};
                html_doc = '';
                
                // æ¸…ç©ºè¾“å…¥è¾“å‡ºæ¡†
                dataInput.value = '';
                dataOutput.value = '';
                
                // å¯ç”¨è¾“å…¥æ¡†
                dataInput.disabled = false;
                dataInput.style.backgroundColor = '';
                dataInput.style.cursor = '';
                
                // é‡ç½®æ‰€æœ‰å¤é€‰æ¡†
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                // åˆ·æ–°iframe
                handleOutput();
                
                // åˆ·æ–°é¡µé¢
                window.location.reload();
                window.history.go(0);
            }

            // function
            function handleOutput() {
                iframeDoc.open();
                iframeDoc.write(html_doc);
                iframeDoc.close();
            }
            // ç»™h1~h6,pæ ‡ç­¾åŠ ä¸Šmarginï¼š0ï¼›
            function addMargin() {
                const elements = iframeDoc.querySelectorAll('h1, h2, h3, h4, h5, h6, p');
                console.log("ğŸš€ ~ addMargin ~ elements:", elements)
                elements.forEach(dom => {
                    if (!dom.style.margin && !dom.style.marginTop && !dom.style.marginRight && !dom.style.marginBottom && !dom.style.marginLeft) {
                        console.log('åŠ  margin');
                        dom.style.margin = '0';
                        if (dom.style.color && !generateColorPlaceholder.includes(dom.style.color)) {
                            const hexColor = rgbToHex(dom.style.color)
                            dom.style.color = 'cornflowerblue'
                            hexColorObj.addMargin.push(hexColor)
                        }
                    }
                });
            }
            // åˆ é™¤aæ ‡ç­¾ä¸‹åˆ’çº¿
            function delUnderline() {
                const elements = iframeDoc.querySelectorAll('a');
                console.log("ğŸš€ ~ delUnderline ~ elements:", elements)
                elements.forEach(a => {
                    if (!a.style.textDecoration) {
                        const computedTextDecoration = window.getComputedStyle(a).textDecorationLine
                        console.log('aæ ‡ç­¾è®¡ç®—æ ·å¼', computedTextDecoration, 'aæ ‡ç­¾è¡Œå†…æ ·å¼', a.style.textDecoration);
                        a.style.textDecoration = computedTextDecoration
                        if (a.style.color && !generateColorPlaceholder.includes(a.style.color)) {
                            const hexColor = rgbToHex(a.style.color)
                            a.style.color = 'mediumspringgreen'
                            hexColorObj.delUnderline.push(hexColor)
                        }
                    }
                });
            }
            // æ›¿æ¢æ‰€æœ‰font-family
            function replaceFontFamily() {
                let newFontFamily
                const curlang = iframeDoc.documentElement.lang;
                console.log("ğŸš€ ~ replaceFontFamily ~ curlang:", curlang)
                langArr.forEach(o => {
                    if (o.lang == curlang) {
                        newFontFamily = o.font
                    }
                })
                let htmlContent = iframeDoc.documentElement.outerHTML
                const regex = /font-family:\s*[^;]+;/g;
                htmlContent = htmlContent.replace(regex, newFontFamily)
                html_doc = htmlContent
                handleOutput()
            }
            // ç¬¬ä¸€ä¸ªTableæ·»åŠ font-family
            function tableFontFamily() {
                let newFontFamily
                const curlang = iframeDoc.documentElement.lang;
                langArr.forEach(o => {
                    if (o.lang == curlang) {
                        newFontFamily = o.font
                    }
                })
                const elements = iframeDoc.querySelector('table');
                let htmlContent = iframeDoc.documentElement.outerHTML
                if (elements && !elements.style.fontFamily) {
                    console.log('æ›¿æ¢ç¬¬ä¸€ä¸ªfontfamily');
                    htmlContent = htmlContent.replace(/\<table/, `<table style="${newFontFamily}"`)
                    html_doc = htmlContent
                }
                handleOutput()
            }
            // æ›¿æ¢preview-copyä¸­çš„nbsp
            function replacePreNbsp() {
                let htmlContent = iframeDoc.documentElement.outerHTML
                const preCopyString = htmlContent.replace(/<div style="display: none; max-height: 0px; overflow: hidden;">([\s\S]*?)<\/div>/, (match, content) => {
                    match = match.replace(content, preCopyNbsp)
                    return match; // æ›¿æ¢ä¸ºå ä½ç¬¦
                });
                html_doc = preCopyString
                handleOutput()
            }
            // åˆ é™¤æœ«å°¾footeréƒ¨åˆ†nbsp
            function delNbsp() {
                let htmlContent = iframeDoc.documentElement.outerHTML
                const pattern = /(&nbsp;&nbsp;&nbsp;&nbsp;\|&nbsp;&nbsp;&nbsp;&nbsp;)/g;
                let matches = htmlContent.match(pattern);
                console.log("ğŸš€ ~ delNbsp ~ matches:", matches)
                if (matches.length == 4) {
                    let count = 0; // ç”¨äºè®¡æ•°æ›¿æ¢æ¬¡æ•°
                    const modifiedString = htmlContent.replace(pattern, (match) => {
                        count++;
                        return (count > 2) ? '&nbsp;&nbsp;&nbsp;&nbsp;\|&nbsp;&nbsp;&nbsp; ' : match;
                    });
                    html_doc = modifiedString
                    handleOutput()
                }
            }
            // åˆ é™¤414åª’ä½“æŸ¥è¯¢
            function del414Media() {
                let htmlContent = iframeDoc.documentElement.outerHTML
                let regex = /@media\s*screen\s*and\s*\(\s*max-device-width\s*:\s*414px\s*\)\s*{\s*u\s*~\s*div\s*{\s*min-width:\s*375px\s*;\s*}\s*body\s*,\s*u\s*\+\s*div\s*{\s*min-width\s*:\s*375px\s*;\s*}\s*}/;
                let replacement = `@media screen and (max-device-width:414px) {
          u ~ div { min-width: 100%;}
          body,u+div { min-width: 100%;}
        }`;
                html_doc = htmlContent.replace(regex, replacement);
                console.log("ğŸš€ ~ æ›¿æ¢414")
                handleOutput()
            }
            // legalæœ«å°¾é˜²æ­¢å•å­—
            function legalPackage() {
                // è·å–sfcopyæ‰€æœ‰çš„ p æ ‡ç­¾
                const sfcopy = iframeDoc.querySelectorAll('.sfcopy');
                const paragraphs = sfcopy[0] ? sfcopy[0].querySelectorAll('p') : [];
                console.log("ğŸš€ ~ legalPackage ~ paragraphs:", paragraphs)
                paragraphs.forEach(p => {
                    // è·å– p æ ‡ç­¾çš„å†…å®¹
                    const text = p.innerHTML;
                    // æ£€æŸ¥æœ€åä¸‰ä¸ªå­—ç¬¦
                    if (text.length >= 3) {
                        const lastThreeChars = text.slice(-3);
                        const regex = /^[\u4e00-\u9fa5]{2}\ã€‚$/; // åŒ¹é…ä¸¤ä¸ªä¸­æ–‡å­—ç¬¦åŠ ä¸€ä¸ªå¥å·
                        // å¦‚æœåŒ¹é…ï¼Œè¿›è¡Œæ›¿æ¢
                        if (regex.test(lastThreeChars)) {
                            // ç”¨ <span> åŒ…è£¹æœ€åä¸‰ä¸ªå­—ç¬¦
                            const wrappedText = text.slice(0, -3) + '<span class="nowrap" style="white-space: nowrap !important;">' + lastThreeChars + '</span>';
                            p.innerHTML = wrappedText;
                        }
                    }
                });
            }
            // æ›¿æ¢cssä¸­>pé€‰æ‹©å™¨
            function replacepSelector() {
                let htmlContent = iframeDoc.documentElement.outerHTML
                const regex = /\.m-.+?(>)p/g;
                html_doc = htmlContent.replace(regex, (match, content) => {
                    return match.replace(content, ' ');
                });
                console.log("ğŸš€ ~ æ›¿æ¢>pé€‰æ‹©å™¨")
                handleOutput()
            }
            // imgå›¾ç‰‡è®¾ç½®å±…ä¸­
            function imgToCenter() {
                const imgElement = iframeDoc.querySelectorAll('img');
                imgElement.forEach(o => {
                    const computedImgDisplay = window.getComputedStyle(o).display
                    const computedImgMarginLeft = window.getComputedStyle(o).marginLeft
                    const computedImgMarginRight = window.getComputedStyle(o).marginRight
                    const computedImgTextAlign = window.getComputedStyle(o).textAlign
                    // console.log("ğŸš€ ~ imgToCenter ~ å›¾ç‰‡display:", computedImgDisplay)
                    if (computedImgDisplay == 'block' && computedImgMarginLeft != '0px' && computedImgMarginLeft != '0' && computedImgMarginRight != '0px' && computedImgMarginRight != '0') {
                        o.style.display = 'inline-block'
                        o.style.textAlign = 'center'
                        // è·å–å›¾ç‰‡çš„ç¬¬ä¸€ä¸ªçˆ¶å…ƒç´ å¹¶è®¾ç½®å…¶è¡Œé«˜ä¸º0
                        if (o && o.parentElement) {
                        o.parentElement.style.lineHeight = '0';
                        }
                    } else if (computedImgDisplay == 'inline-block' && computedImgTextAlign == 'center') {
                        o.style.display = 'inline-block'
                        o.style.textAlign = 'center'
                    }
                })
            }
            // æ—¥æœŸé—´æ·»åŠ zwnj
            function addDateZwnj() {

                let htmlContent = iframeDoc.documentElement.outerHTML
                // æ·»åŠ æ­£åˆ™åŒ¹é…å’Œæ›¿æ¢é€»è¾‘
                const datePatterns = [
                    /(\d{4})\så¹´\s(\d{1,2})\sæœˆ\s(\d{1,2})\sæ—¥/g,
                    /(\d{4})\så¹´\s(\d{1,2})\sæœˆ/g,
                    /(\d{1,2})\sæœˆ\s(\d{1,2})\sæ—¥/g,
                    /(\d{4})\så¹´/g,
                    /(\d{1,2})\sæœˆ/g,
                ];

                datePatterns.forEach(pattern => {
                    htmlContent = htmlContent.replace(pattern, (match) => {
                        // å°†æ—¥æœŸä¸­çš„æ¯ä¸ªå­—ç¬¦ç”¨ &zwnj; è¿æ¥
                        console.log(match, 'hh');

                        return match.split('').join('&zwnj;');
                    });
                });
                html_doc = htmlContent;
                handleOutput();
            }
            // footerä¸‹è½½appStoreä¸æ¢è¡Œ
            function appStoreNowrap() {
                //æŸ¥æ‰¾aæ ‡ç­¾ï¼Œå¦‚æœhref="${clicks.get('BNAV_APP')}"ï¼Œåˆ™è®¾ç½®white-space:nowrap
                const a = iframeDoc.querySelectorAll('a');

                a.forEach(o => {

                    if (o.href.includes("clicks.get('BNAV_APP')")) {
                        o.style.setProperty('white-space', 'nowrap');
                        if (o.style.color && !generateColorPlaceholder.includes(o.style.color)) {
                            const hexColor = rgbToHex(o.style.color)
                            console.log("ğŸš€ ~ appStoreNowrap ~ hexColor:", hexColor)
                            o.style.color = 'blanchedalmond'
                            hexColorObj.appStoreNowrap.push(hexColor)
                        }
                    }
                })
            }

            // mobileçš„supæ ‡ç­¾è®¾ç½®è¡Œå†…æ ·å¼ï¼ˆsinaé‚®ç®±ï¼‰
            function supNormalSize() {
                const desktopContainer = iframeDoc.querySelectorAll('.desktop-container');
                const sups = desktopContainer[0].querySelectorAll('sup');
                sups.forEach(o => {
                    o.style.fontSize = '0.65em'
                    o.style.lineHeight = '0'
                    o.style.verticalAlign = 'super'
                })
            }
            // mobileçš„spanæ ‡ç­¾å¦‚æœè®¾ç½®äº†white-space:nowrap,è®¾ç½®classç±»ånowrapï¼Œå¹¶ä¸”nowrapåŠ importantï¼ˆ163é‚®ç®±ï¼‰
            function setNowrapSpan() {

                const mobileContainer = iframeDoc.querySelectorAll('.mobile-container');
                const sfcopy = iframeDoc.querySelectorAll('.sfcopy span');
                const spans = mobileContainer[0].querySelectorAll('span');
                [...spans, ...sfcopy].forEach(o => {
                    if (o.style.whiteSpace == 'nowrap') {
                        o.style.setProperty('white-space', 'nowrap', 'important')
                        o.classList.add('nowrap')
                    }
                })

                let htmlContent = iframeDoc.documentElement.outerHTML
                // æ·»åŠ æ­£åˆ™åŒ¹é…å’Œæ›¿æ¢é€»è¾‘
                const regex = /\.eyebrow-text\s*,\s*\.nowrap\s*\{\s*white-space\s*:\s*nowrap\s*;\s*\}/g;
                html_doc = htmlContent.replace(regex, '.eyebrow-text, .nowrap { white-space: nowrap !important; }');
                handleOutput();
            }

            // desktopå»é™¤ä¸‹åˆ’çº¿çš„!important
            function delUnderlineImportant() {

                const desktopContainer = iframeDoc.querySelectorAll('.desktop-container');
                const a_href = desktopContainer[0].querySelectorAll('a');
                a_href.forEach(a => {
                    if (!a.className.includes('btn')) {
                        a.style.textDecoration = 'none';
                        if (a.style.color && !generateColorPlaceholder.includes(a.style.color)) {
                            console.log("ğŸš€ ~ delUnderlineImportant ~ a.style.color:", a.style.color)
                            const hexColor = rgbToHex(a.style.color)
                            a.style.color = 'lightgoldenrodyellow'
                            console.log("ğŸš€ çœ‹çœ‹é¢œè‰²å˜æˆå•¥~ delUnderlineImportant ~ hexColor:", hexColor)
                            hexColorObj.delUnderlineImportant.push(hexColor)
                        }
                    }
                });
            }

        });
    </script>
</body>

</html>